{{ define "body-class" }}template-search{{ end }}
{{ define "head" }}
    <!-- Pagefind ë¦¬ì†ŒìŠ¤ -->
    <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
    
    <!-- ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ë¦¬ì†ŒìŠ¤ íŒíŠ¸ -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="/pagefind/" crossorigin>
    
    <!-- ì´ë¯¸ì§€ ìµœì í™”ë¥¼ ìœ„í•œ ë©”íƒ€ íƒœê·¸ -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- ê²€ìƒ‰ ê²°ê³¼ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ -->
    <style>
        /* Skeleton ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes skeleton-loading {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }
        
        /* ê²€ìƒ‰ ê²°ê³¼ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .search-result-image {
            border: 1px solid #e0e0e0;
            background-color: #f8f9fa;
        }
        
        /* í†µí•©ëœ ë‹¤í¬ëª¨ë“œ ì§€ì› */
        @media (prefers-color-scheme: dark) {
            .search-result-image {
                border-color: #404040;
                background-color: #2a2a2a;
                background: linear-gradient(90deg, #404040 25%, transparent 37%, #404040 63%);
                background-size: 400% 100%;
            }
        }
        
        [data-scheme="dark"] .search-result-image {
            border-color: #404040;
            background-color: #2a2a2a;
            background: linear-gradient(90deg, #404040 25%, transparent 37%, #404040 63%);
            background-size: 400% 100%;
        }
    </style>
{{ end }}
{{ define "main" }}
<form class="search-form" onsubmit="return false;">
    <p>
        <label>{{ T "search.title" }}</label>
        <input id="pagefind-search-input" name="keyword" placeholder="{{ T `search.placeholder` }}" />
    </p>

    <button type="button" title="{{ T `search.title` }}" onclick="triggerSearch()">
        {{ partial "helper/icon" "search" }}
    </button>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list article-list--compact">
        <div id="search"></div>
    </div>
</div>

<script>
/**
 * Pagefind ê²€ìƒ‰ í˜ì´ì§€ - ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ ë° ì´ë¯¸ì§€ ìµœì í™”
 * 
 * ì£¼ìš” ê¸°ëŠ¥:
 * - ê²€ìƒ‰ ê²°ê³¼ ìƒì„± ì‹œ ì¦‰ì‹œ ì´ë¯¸ì§€ placeholder í¬í•¨
 * - ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ì™„ì „ ë°©ì§€
 * - ìŠ¤ë§ˆíŠ¸ ì´ë¯¸ì§€ ë¡œë”© ë° ìºì‹±
 * - ì„±ëŠ¥ ìµœì í™”ëœ ì´ë¯¸ì§€ ì²˜ë¦¬
 */

// ========================================
// ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
// ========================================

let pagefindInstance;

// ì´ë¯¸ì§€ URL ì €ì¥ì†Œ
const imageUrlStore = new Map();

// ========================================
// ì´ë¯¸ì§€ ìºì‹œ ê´€ë¦¬ ì‹œìŠ¤í…œ
// ========================================

const ImageCacheManager = {
    cache: new Map(),
    failedUrls: new Set(),
    
    get(url) {
        return this.cache.get(url);
    },

    set(url, imageUrl) {
        this.cache.set(url, imageUrl);
    },

    isFailed(url) {
        return this.failedUrls.has(url);
    },

    addFailed(url) {
        this.failedUrls.add(url);
    }
};

// ========================================
// ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ ì‹œìŠ¤í…œ
// ========================================

/**
 * ê²€ìƒ‰ ê²°ê³¼ì— ì¦‰ì‹œ ì´ë¯¸ì§€ placeholder ì¶”ê°€ (ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€)
 * @param {HTMLElement} result - ê²€ìƒ‰ ê²°ê³¼ ì—˜ë¦¬ë¨¼íŠ¸
 */
function addImagePlaceholderToResult(result) {
    // ì´ë¯¸ placeholderê°€ ìˆëŠ”ì§€ í™•ì¸
    if (result.querySelector('.search-result-image')) return;
    
    const isMobile = window.innerWidth <= 768;
    const isDarkMode = document.documentElement.getAttribute('data-scheme') === 'dark' || 
                      document.documentElement.classList.contains('dark') || 
                      document.body.classList.contains('dark') ||
                      window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    // ì´ë¯¸ì§€ placeholder ì»¨í…Œì´ë„ˆ ìƒì„±
    const imageContainer = document.createElement('div');
    imageContainer.className = 'search-result-image';
    imageContainer.style.cssText = createImageContainerStyle(isMobile, isDarkMode, true);
    
    // ê²€ìƒ‰ ê²°ê³¼ êµ¬ì¡° ì¬êµ¬ì„±
    const resultContent = document.createElement('div');
    resultContent.className = 'search-result-content';
    
    // ê¸°ì¡´ ë‚´ìš©ì„ ìƒˆ ì»¨í…Œì´ë„ˆë¡œ ì´ë™
    while (result.firstChild) {
        resultContent.appendChild(result.firstChild);
    }
    
    // ì´ë¯¸ì§€ placeholderì™€ ë‚´ìš©ì„ ê²°ê³¼ì— ì¶”ê°€
    result.appendChild(imageContainer);
    result.appendChild(resultContent);
    result.classList.add('has-image');
    
    console.log('ğŸ“¦ ì´ë¯¸ì§€ placeholder ì¶”ê°€ (ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€):', result);
}

/**
 * ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ìƒì„±
 */
function createImageContainerStyle(isMobile, isDarkMode, isSkeleton = false) {
    const width = isMobile ? '100%' : '120px';
    const height = isMobile ? '200px' : '120px';
    const margin = isMobile ? '0 0 1rem 0' : '0rem 0rem 0 0';
    
    if (isSkeleton) {
        const bgColor = isDarkMode ? '#404040' : '#f0f0f0';
        return `
            width: ${width}; height: ${height}; flex-shrink: 0; position: relative;
            background: linear-gradient(90deg, ${bgColor} 25%, transparent 37%, ${bgColor} 63%);
            background-size: 400% 100%; animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px; overflow: hidden; margin: ${margin};
            border: 1px solid ${isDarkMode ? '#404040' : '#e0e0e0'}; 
            background-color: ${isDarkMode ? '#2a2a2a' : '#f8f9fa'}; 
            order: -1; display: flex; align-items: center; justify-content: center;
        `;
    } else {
        const bgColor = isDarkMode ? '#2a2a2a' : '#f8f9fa';
        const borderColor = isDarkMode ? '#444' : '#e0e0e0';
        
        return `
            width: ${width}; height: ${height}; flex-shrink: 0; position: relative;
            background: ${bgColor}; border: 1px solid ${borderColor};
            border-radius: 8px; overflow: hidden; margin: ${margin};
            display: flex; align-items: center; justify-content: center; order: -1;
        `;
    }
}

/**
 * ì´ë¯¸ì§€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± ë° placeholder êµì²´
 */
function createImageElement(result, link, imageUrl) {
    const imageContainer = result.querySelector('.search-result-image');
    if (!imageContainer) return;
    
    // skeleton ì• ë‹ˆë©”ì´ì…˜ ì œê±°
    imageContainer.style.animation = 'none';
    
    const img = document.createElement('img');
    img.alt = link.textContent;
    img.loading = 'lazy';
    img.style.cssText = `
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    `;
    
    // ì´ë¯¸ì§€ ë¡œë”© ì‹œì‘
    img.src = imageUrl;
    
    // ì´ë¯¸ì§€ ë¡œë”© ì„±ê³µ ì‹œ
    img.onload = function() {
        console.log('âœ… ì´ë¯¸ì§€ ë¡œë”© ì™„ë£Œ:', img.src);
        const pageUrl = link.href;
        if (pageUrl) {
            ImageCacheManager.set(pageUrl, img.src);
        }
        
        // skeleton ì œê±° ë° ì´ë¯¸ì§€ í‘œì‹œ
        imageContainer.style.background = 'var(--card-background, #ffffff)';
        imageContainer.style.border = '1px solid var(--card-separator-color, #ddd)';
        img.style.opacity = '1';
    };
    
    // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ
    img.onerror = function() {
        console.log('âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', imageUrl);
        
        // ì‹¤íŒ¨ í‘œì‹œ
        const isDarkMode = document.documentElement.getAttribute('data-scheme') === 'dark' || 
                          document.documentElement.classList.contains('dark') || 
                          document.body.classList.contains('dark') ||
                          window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        imageContainer.style.background = isDarkMode ? '#2a2a2a' : '#f8f9fa';
        imageContainer.style.border = `1px solid ${isDarkMode ? '#444' : '#e0e0e0'}`;
        imageContainer.style.animation = 'none';
        
        // ì´ë¯¸ì§€ ì œê±°í•˜ê³  ì‹¤íŒ¨ ë©”ì‹œì§€ ì¶”ê°€
        if (img.parentNode) {
            img.parentNode.removeChild(img);
        }
        
        const textColor = isDarkMode ? '#a0a0a0' : '#6c757d';
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `display: flex; align-items: center; justify-content: center; height: 100%; color: ${textColor}; font-size: 12px; text-align: center; padding: 8px;`;
        errorDiv.textContent = 'ì´ë¯¸ì§€ ì—†ìŒ';
        imageContainer.appendChild(errorDiv);
    };
    
    // ê¸°ì¡´ ë‚´ìš© ì œê±°í•˜ê³  ì´ë¯¸ì§€ ì¶”ê°€
    imageContainer.innerHTML = '';
    imageContainer.appendChild(img);
}

/**
 * ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° placeholderë¥¼ "ì´ë¯¸ì§€ ì—†ìŒ"ìœ¼ë¡œ ë³€ê²½
 */
function showNoImagePlaceholder(result, link) {
    const imageContainer = result.querySelector('.search-result-image');
    if (!imageContainer) return;
    
    const isDarkMode = document.documentElement.getAttribute('data-scheme') === 'dark' || 
                      document.documentElement.classList.contains('dark') || 
                      document.body.classList.contains('dark') ||
                      window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    imageContainer.style.background = isDarkMode ? '#2a2a2a' : '#f8f9fa';
    imageContainer.style.border = `1px solid ${isDarkMode ? '#444' : '#e0e0e0'}`;
    imageContainer.style.animation = 'none';
    
    const textColor = isDarkMode ? '#a0a0a0' : '#6c757d';
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `display: flex; align-items: center; justify-content: center; height: 100%; color: ${textColor}; font-size: 12px; text-align: center; padding: 8px;`;
    errorDiv.textContent = 'ì´ë¯¸ì§€ ì—†ìŒ';
    imageContainer.innerHTML = '';
    imageContainer.appendChild(errorDiv);
    
    console.log('ğŸ“¦ "ì´ë¯¸ì§€ ì—†ìŒ" placeholder ìƒì„±:', link.href);
}

// ========================================
// ì´ë¯¸ì§€ ê²€ìƒ‰ ì‹œìŠ¤í…œ
// ========================================

const ImageCandidateGenerator = {
    priorityFiles: [
        'poster.webp',
        'poster.jpg',
        'poster.png'
    ],

    generate(pageUrl) {
        const url = new URL(pageUrl, window.location.origin);
        const basePath = url.pathname.endsWith('/') ? url.pathname.slice(0, -1) : url.pathname;
        const candidates = [];

        this.priorityFiles.forEach(filename => {
            candidates.push(`${basePath}/${filename}`);
        });

        return candidates;
    }
};

/**
 * í—¤ë” ì´ë¯¸ì§€ ê²€ìƒ‰
 */
async function fetchHeaderImage(pageUrl) {
    try {
        console.log('ğŸ” ì´ë¯¸ì§€ ê²€ìƒ‰:', pageUrl);
        
        // 1. ê¸°ë³¸ í›„ë³´ ì‹œë„
        const imageCandidates = ImageCandidateGenerator.generate(pageUrl);
        for (const imageUrl of imageCandidates) {
            if (ImageCacheManager.isFailed(imageUrl)) continue;
            
            try {
                const response = await fetch(imageUrl, { method: 'HEAD' });
                if (response.ok) {
                    console.log('âœ… ê¸°ë³¸ í›„ë³´ì—ì„œ ì´ë¯¸ì§€ ë°œê²¬:', imageUrl);
                    return imageUrl;
                }
                ImageCacheManager.addFailed(imageUrl);
            } catch (e) {
                ImageCacheManager.addFailed(imageUrl);
            }
        }
        
        // 2. HTML íŒŒì‹±ìœ¼ë¡œ ì´ë¯¸ì§€ ì°¾ê¸°
        console.log('ğŸ” HTML íŒŒì‹±ìœ¼ë¡œ ì´ë¯¸ì§€ ê²€ìƒ‰:', pageUrl);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(pageUrl, { 
            signal: controller.signal,
            cache: 'force-cache'
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            console.log('âŒ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', response.status, pageUrl);
            return null;
        }
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // 3. article ë‚´ ì´ë¯¸ì§€ ì°¾ê¸°
        const articleImages = doc.querySelectorAll('article img, .article-content img, .content img, main img');
        console.log('ğŸ“° Article ì´ë¯¸ì§€ ê°œìˆ˜:', articleImages.length);
        
        for (const articleImg of articleImages) {
            let src = articleImg.src || articleImg.getAttribute('src') || articleImg.getAttribute('data-src');
            if (!src) continue;
            
            if (src.includes('avatar') || src.includes('favicon') || src.endsWith('.ico')) {
                continue;
            }
            
            if (src.includes('localhost:12345')) {
                src = src.replace('localhost:12345', window.location.host);
            }
            
            if (src.startsWith('/')) {
                src = window.location.origin + src;
            }
            
            console.log('âœ… Article ì´ë¯¸ì§€ ë°œê²¬:', src);
            return src;
        }
        
        console.log('âŒ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', pageUrl);
        return null;
    } catch (error) {
        if (error.name !== 'AbortError') {
            console.warn('ì´ë¯¸ì§€ ê²€ìƒ‰ ì‹¤íŒ¨:', pageUrl, error.message);
        }
        return null;
    }
}

// ========================================
// ë©”ì¸ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ì²˜ë¦¬
// ========================================

window.addEventListener('DOMContentLoaded', (event) => {
    // PagefindUI ì´ˆê¸°í™”
    pagefindInstance = new PagefindUI({ 
        element: "#search", 
        showSubResults: true,
        showEmptyFilters: true,
        resetStyles: false,
        autofocus: false,
        processResult: function(result) {
            // ì œëª© ì²˜ë¦¬
            if (result.meta && result.meta.title) {
                result.meta.title = result.meta.title.trim();
            }
            
            // ì‘ì„±ì ì •ë³´ ì •ë¦¬
            if (result.meta && result.meta.author === "42jerrykim") {
                delete result.meta.author;
            }
            
            // ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì²˜ë¦¬
            let imageUrl = null;
            if (result.meta && result.meta.image) {
                imageUrl = result.meta.image.trim();
                console.log('ğŸ“‹ Pagefind Meta ì´ë¯¸ì§€ ë°œê²¬:', imageUrl, 'for', result.url);
                
                if (imageUrl.startsWith('/')) {
                    imageUrl = window.location.origin + imageUrl;
                } else if (!imageUrl.startsWith('http')) {
                    imageUrl = window.location.origin + '/' + imageUrl;
                }
                
                console.log('âœ… Pagefind Meta ì´ë¯¸ì§€ ì²˜ë¦¬ë¨:', imageUrl);
            }
            
            // ì´ë¯¸ì§€ URL ì €ì¥
            if (imageUrl && !imageUrl.includes('avatar')) {
                imageUrlStore.set(result.url, imageUrl);
                console.log('ğŸ’¾ ì´ë¯¸ì§€ URL ì €ì¥:', result.url, 'â†’', imageUrl);
            }
            
            return result;
        },
        translations: {
            placeholder: "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...",
            clear_search: "ê²€ìƒ‰ ì§€ìš°ê¸°",
            load_more: "ë” ë³´ê¸°",
            search_label: "ì‚¬ì´íŠ¸ ê²€ìƒ‰",
            filters_label: "í•„í„°",
            zero_results: "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤: [SEARCH_TERM]",
            many_results: "[COUNT]ê°œì˜ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤: [SEARCH_TERM]",
            one_result: "1ê°œì˜ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤: [SEARCH_TERM]",
            alt_search: "ê²€ìƒ‰: [SEARCH_TERM]",
            search_suggestion: "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
            searching: "ê²€ìƒ‰ ì¤‘..."
        }
    });
    
    // PagefindUI ê¸°ë³¸ ê²€ìƒ‰ ì…ë ¥ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        const pagefindInput = document.querySelector('.pagefind-ui__search-input');
        if (pagefindInput) {
            pagefindInput.style.display = 'none';
        }
        
        // ì´ˆê¸° ê²€ìƒ‰ ê²°ê³¼ì— ì´ë¯¸ì§€ placeholder ì¶”ê°€
        addImagesToResults();
    }, 100);
    
    // MutationObserverë¡œ ìƒˆë¡œìš´ ê²€ìƒ‰ ê²°ê³¼ ê°ì§€
    const observer = new MutationObserver(function(mutations) {
        let needImageUpdate = false;
        
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                for (let node of mutation.addedNodes) {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // ê²€ìƒ‰ ê²°ê³¼ ì¶”ê°€ ê°ì§€
                        if (node.classList.contains('pagefind-ui__result') || 
                            (node.querySelector && node.querySelector('.pagefind-ui__result'))) {
                            needImageUpdate = true;
                        }
                        
                        // ì¸ë„¤ì¼ ì œê±°
                        if (node.classList.contains('pagefind-ui__result-thumb')) {
                            node.remove();
                        }
                        
                        // í´ë¦¬ì–´ ë²„íŠ¼ ì œê±°
                        if (node.classList.contains('pagefind-ui__search-clear')) {
                            node.remove();
                        }
                    }
                }
            }
        });
        
        if (needImageUpdate) {
            console.log('ğŸ”„ ìƒˆë¡œìš´ ê²€ìƒ‰ ê²°ê³¼ ê°ì§€, ì¦‰ì‹œ ì´ë¯¸ì§€ placeholder ì¶”ê°€');
            // ì¦‰ì‹œ ì´ë¯¸ì§€ placeholder ì¶”ê°€ (ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€)
            setTimeout(() => {
                addImmediateImagePlaceholders();
            }, 10);
            
            // ì‹¤ì œ ì´ë¯¸ì§€ ë¡œë”© ì‹œë„
            setTimeout(addImagesToResults, 300);
        }
    });
    
    // ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ ê´€ì°°
    const searchContainer = document.getElementById('search');
    if (searchContainer) {
        observer.observe(searchContainer, { childList: true, subtree: true });
    }
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²€ìƒ‰ì–´ ì¶”ì¶œ
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('keyword') || urlParams.get('q') || urlParams.get('search');
    
    if (searchQuery) {
        document.getElementById('pagefind-search-input').value = searchQuery;
        setTimeout(() => {
            SearchUtils.triggerSearch();
        }, 500);
    }
    
    // ì»¤ìŠ¤í…€ ê²€ìƒ‰ ì…ë ¥ê³¼ PagefindUI ì—°ê²°
    const customInput = document.getElementById('pagefind-search-input');
    customInput.addEventListener('input', function() {
        const pagefindInput = document.querySelector('.pagefind-ui__search-input');
        if (pagefindInput) {
            pagefindInput.value = this.value;
            pagefindInput.dispatchEvent(new Event('input'));
        }
        SearchUtils.updateSearchResultTitle(this.value);
    });
    
    // ì—”í„° í‚¤ ê²€ìƒ‰ ì§€ì›
    customInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            SearchUtils.triggerSearch();
        }
    });
});

/**
 * ëª¨ë“  ê²€ìƒ‰ ê²°ê³¼ì— ì¦‰ì‹œ ì´ë¯¸ì§€ placeholder ì¶”ê°€ (ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€)
 */
function addImmediateImagePlaceholders() {
    const results = document.querySelectorAll('.pagefind-ui__result:not(.placeholder-added)');
    
    results.forEach(result => {
        const link = result.querySelector('.pagefind-ui__result-link');
        if (!link) return;
        
        // ì¦‰ì‹œ ì´ë¯¸ì§€ placeholder ì¶”ê°€ (ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€)
        addImagePlaceholderToResult(result);
        result.classList.add('placeholder-added');
        
        console.log('ğŸ“¦ ì¦‰ì‹œ ì´ë¯¸ì§€ placeholder ì¶”ê°€:', link.href);
    });
}

/**
 * ëª¨ë“  ê²€ìƒ‰ ê²°ê³¼ì— ì´ë¯¸ì§€ placeholder ì¶”ê°€ ë° ì´ë¯¸ì§€ ë¡œë”©
 */
function addImagesToResults() {
    const results = document.querySelectorAll('.pagefind-ui__result:not(.image-processed)');
    
    results.forEach(result => {
        const link = result.querySelector('.pagefind-ui__result-link');
        if (!link) return;
        
        result.classList.add('image-processed');
        
        const url = link.href;
        
        // 1. Pagefind ë©”íƒ€ ì´ë¯¸ì§€ í™•ì¸
        const pagefindMetaImage = imageUrlStore.get(url);
        if (pagefindMetaImage) {
            console.log('âœ… ì €ì¥ëœ ì´ë¯¸ì§€ URL ì‚¬ìš©:', pagefindMetaImage);
            createImageElement(result, link, pagefindMetaImage);
            ImageCacheManager.set(url, pagefindMetaImage);
            return;
        }
        
        // 2. ìºì‹œëœ ì´ë¯¸ì§€ í™•ì¸
        const cachedImageUrl = ImageCacheManager.get(url);
        if (cachedImageUrl) {
            console.log('ğŸ’¾ ìºì‹œëœ ì´ë¯¸ì§€ ì‚¬ìš©:', url, 'â†’', cachedImageUrl);
            if (cachedImageUrl !== 'NO_IMAGE') {
                createImageElement(result, link, cachedImageUrl);
            } else {
                showNoImagePlaceholder(result, link);
            }
        } else {
            // 3. ìƒˆë¡œìš´ ì´ë¯¸ì§€ ê²€ìƒ‰
            console.log('ğŸ” ìƒˆë¡œìš´ ì´ë¯¸ì§€ ê²€ìƒ‰ ì‹œì‘:', url);
            fetchHeaderImage(url).then(headerImageUrl => {
                if (!document.body.contains(result)) return;
                
                ImageCacheManager.set(url, headerImageUrl || 'NO_IMAGE');
                
                if (headerImageUrl) {
                    console.log('âœ… ì´ë¯¸ì§€ ë°œê²¬ ë° ìƒì„±:', headerImageUrl);
                    createImageElement(result, link, headerImageUrl);
                } else {
                    showNoImagePlaceholder(result, link);
                }
            }).catch((error) => {
                console.log('âŒ ì´ë¯¸ì§€ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                ImageCacheManager.set(url, 'NO_IMAGE');
                showNoImagePlaceholder(result, link);
            });
        }
    });
}

// ========================================
// ê²€ìƒ‰ ìœ í‹¸ë¦¬í‹°
// ========================================

const SearchUtils = {
    triggerSearch() {
        const searchTerm = document.getElementById('pagefind-search-input').value;
        const pagefindInput = document.querySelector('.pagefind-ui__search-input');
        if (pagefindInput) {
            pagefindInput.value = searchTerm;
            pagefindInput.dispatchEvent(new Event('input'));
        }
        this.updateSearchResultTitle(searchTerm);
    },

    updateSearchResultTitle(searchTerm) {
        const resultTitle = document.querySelector('.search-result--title');
        if (searchTerm.trim()) {
            resultTitle.textContent = `"${searchTerm}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼`;
            resultTitle.style.display = 'block';
        } else {
            resultTitle.style.display = 'none';
        }
    }
};

// ì „ì—­ ì ‘ê·¼ì„ ìœ„í•œ ë³„ì¹­
window.triggerSearch = () => SearchUtils.triggerSearch();
</script>

<style>
    /* PagefindUI ê¸°ë³¸ ê²€ìƒ‰ ì…ë ¥ ìˆ¨ê¸°ê¸° */
    .pagefind-ui__search-input {
        display: none !important;
    }
    
    /* PagefindUI ê²°ê³¼ë¥¼ article-list--compact ìŠ¤íƒ€ì¼ë¡œ ë³€í™˜ */
    .pagefind-ui__results {
        margin-top: 0;
    }
    
    .pagefind-ui__result {
        display: flex !important;
        align-items: flex-start !important;
        margin-bottom: 1.5rem !important;
        padding: 0 2rem 1.5rem !important;
        border: none !important;
        border-radius: 0 !important;
        background: transparent !important;
        transition: none !important;
        transform: none !important;
        box-shadow: none !important;
        border-bottom: 1px solid var(--card-separator-color, #ddd) !important;
        --pagefind-ui-border-width: 0 !important;
        min-height: 120px !important;
        position: relative !important;
        gap: 1rem !important;
        /* ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ë¥¼ ìœ„í•œ ì¶”ê°€ ì†ì„± */
        box-sizing: border-box !important;
        /* ì´ë¯¸ì§€ ì˜ì—­ì„ ìœ„í•œ ê³ ì • ê³µê°„ í™•ë³´ */
        padding-left: 140px !important;
    }
    
    /* ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° íŒ¨ë”© ì¡°ì • */
    .pagefind-ui__result.has-image {
        padding-left: 2rem !important;
    }
    
    .pagefind-ui__result:hover {
        box-shadow: none;
        transform: none;
    }
    
    .pagefind-ui__result:last-child {
        border-bottom: none;
    }
    
    /* ê²€ìƒ‰ ê²°ê³¼ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ - ì ˆëŒ€ ìœ„ì¹˜ë¡œ ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ì™„ì „ ë°©ì§€ */
    .search-result-image {
        position: absolute !important;
        left: 2rem !important;
        top: 1.5rem !important;
        width: 120px !important;
        height: 120px !important;
        border-radius: 8px !important;
        overflow: hidden !important;
        background: var(--card-background, #ffffff) !important;
        border: 1px solid var(--card-separator-color, #ddd) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-width: 120px !important;
        min-height: 120px !important;
        max-width: 120px !important;
        max-height: 120px !important;
        box-sizing: border-box !important;
        z-index: 1 !important;
    }
    
    .search-result-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transform: translateZ(0);
        transition: opacity 0.2s ease;
    }
    
    .search-result-image img[src=""] {
        opacity: 0;
    }
    
    /* ê²€ìƒ‰ ê²°ê³¼ ë‚´ìš© ì˜ì—­ */
    .search-result-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding-left: 0;
        padding-top: 0;
        min-height: 120px;
        /* ì´ë¯¸ì§€ ì˜ì—­ì„ ìœ„í•œ ì—¬ë°± í™•ë³´ */
        margin-left: 140px;
    }
    
    .pagefind-ui__result-link {
        color: var(--card-text-color-main, var(--body-text-color, #1a1a1a));
        text-decoration: none;
        font-weight: 700;
        font-size: 1.8rem;
        line-height: 1.3;
        display: block;
        margin-bottom: 0.8rem;
        transition: color 0.2s ease;
    }
    
    .pagefind-ui__result-link:hover {
        color: var(--accent-color, #007acc);
        text-decoration: underline;
    }
    
    /* ë‹¤í¬ ëª¨ë“œ ì§€ì› */
    @media (prefers-color-scheme: dark) {
        .pagefind-ui__result-link {
            color: var(--card-text-color-main, var(--body-text-color, #ffffff));
        }
        
        .pagefind-ui__result-link:hover {
            color: var(--accent-color, #4a9eff);
        }
        
        .search-result-image {
            background: var(--card-background, #2a2a2a);
            border-color: var(--card-separator-color, #444);
        }
    }
    
    /* ì‚¬ì´íŠ¸ í…Œë§ˆì˜ ë‹¤í¬ ëª¨ë“œ í´ë˜ìŠ¤ ì§€ì› */
    [data-scheme="dark"] .pagefind-ui__result-link,
    .dark .pagefind-ui__result-link,
    body.dark .pagefind-ui__result-link {
        color: var(--card-text-color-main, var(--body-text-color, #ffffff)) !important;
    }
    
    [data-scheme="dark"] .pagefind-ui__result-link:hover,
    .dark .pagefind-ui__result-link:hover,
    body.dark .pagefind-ui__result-link:hover {
        color: var(--accent-color, #4a9eff) !important;
    }
    
    [data-scheme="dark"] .search-result-image,
    .dark .search-result-image,
    body.dark .search-result-image {
        background: var(--card-background, #2a2a2a) !important;
        border-color: var(--card-separator-color, #444) !important;
    }
    
    /* ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ í‘œì‹œë˜ëŠ” í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .search-result-image div {
        text-align: center;
        font-size: 12px;
        color: var(--card-text-color-secondary, #6c757d);
        user-select: none;
    }
    
    [data-scheme="dark"] .search-result-image div,
    .dark .search-result-image div,
    body.dark .search-result-image div {
        color: var(--card-text-color-secondary, #a0a0a0) !important;
    }
    
    .pagefind-ui__result-excerpt {
        color: var(--card-text-color-secondary, var(--body-text-color-secondary, #6b6b6b));
        line-height: 1.6;
        margin-bottom: 0.8rem;
        font-size: 0.95rem;
    }
    
    .pagefind-ui__result-excerpt mark {
        background-color: var(--accent-color-lighter, rgba(0, 122, 204, 0.1));
        color: var(--accent-color-darker, var(--accent-color, #007acc));
        padding: 0.1em 0.3em;
        border-radius: 3px;
        font-weight: 600;
    }
    
    /* ë‹¤í¬ ëª¨ë“œì—ì„œ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ */
    @media (prefers-color-scheme: dark) {
        .pagefind-ui__result-excerpt {
            color: var(--card-text-color-secondary, var(--body-text-color-secondary, #999999));
        }
        
        .pagefind-ui__result-excerpt mark {
            background-color: var(--accent-color-lighter, rgba(74, 158, 255, 0.2));
            color: var(--accent-color, #4a9eff);
        }
    }
    
    [data-scheme="dark"] .pagefind-ui__result-excerpt,
    .dark .pagefind-ui__result-excerpt,
    body.dark .pagefind-ui__result-excerpt {
        color: var(--card-text-color-secondary, var(--body-text-color-secondary, #999999)) !important;
    }
    
    [data-scheme="dark"] .pagefind-ui__result-excerpt mark,
    .dark .pagefind-ui__result-excerpt mark,
    body.dark .pagefind-ui__result-excerpt mark {
        background-color: var(--accent-color-lighter, rgba(74, 158, 255, 0.2)) !important;
        color: var(--accent-color, #4a9eff) !important;
    }
    
    .pagefind-ui__result-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.8rem;
    }
    
    .pagefind-ui__result-tag {
        background: var(--tag-background-color, rgba(0, 122, 204, 0.1));
        color: var(--tag-text-color, var(--accent-color, #007acc));
        padding: 0.3em 0.8em;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .pagefind-ui__result-tag:hover {
        background: var(--tag-background-color-hover, var(--accent-color, #007acc));
        color: var(--tag-text-color-hover, #ffffff);
    }
    
    .pagefind-ui__button {
        background: var(--accent-color, #007acc);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1.5rem;
    }
    
    .pagefind-ui__button:hover {
        background: var(--accent-color-darker, #005a99);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 204, 0.3);
    }
    
    .pagefind-ui__message {
        text-align: center;
        color: var(--card-text-color-secondary, var(--body-text-color-secondary, #6b6b6b));
        font-style: italic;
        margin: 2rem 0;
        font-size: 1.1rem;
    }
    
    /* ê²€ìƒ‰ ê²°ê³¼ ì œëª© ìŠ¤íƒ€ì¼ */
    .search-result--title {
        display: none;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--card-text-color-main, var(--body-text-color, #1a1a1a));
        margin-bottom: 1.5rem;
    }
    
    .search-result--title.show {
        display: block;
    }
    
    /* ë‹¤í¬ ëª¨ë“œì—ì„œ ê²€ìƒ‰ ê²°ê³¼ ì œëª© */
    @media (prefers-color-scheme: dark) {
        .search-result--title {
            color: var(--card-text-color-main, var(--body-text-color, #ffffff));
        }
    }
    
    [data-scheme="dark"] .search-result--title,
    .dark .search-result--title,
    body.dark .search-result--title {
        color: var(--card-text-color-main, var(--body-text-color, #ffffff)) !important;
    }
    
    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• - ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ */
    @media (max-width: 768px) {
        .pagefind-ui__result {
            flex-direction: column;
            align-items: stretch;
            min-height: 200px;
            padding-left: 2rem !important;
        }
        
        .search-result-image {
            position: relative !important;
            left: auto !important;
            top: auto !important;
            width: 100% !important;
            height: 200px !important;
            margin: 0 0 1rem 0 !important;
            min-width: 100% !important;
            min-height: 200px !important;
            max-width: 100% !important;
            max-height: 200px !important;
        }
        
        .search-result-content {
            align-items: flex-start;
            padding-top: 0;
            padding-left: 0;
            min-height: auto;
            margin-left: 0;
        }
        
        .pagefind-ui__result-link {
            font-size: 1.5rem;
        }
    }

    .search-result-image--placeholder {
        background: transparent !important;
        border: none !important;
    }

    .pagefind-ui__form.svelte-e9gkc3:before {
        display: none !important;
        content: none !important;
    }

    .pagefind-ui__message.svelte-e9gkc3 {
        margin-left: 2rem;
        font-size: 1.3rem;
    }
</style>

{{ partialCached "footer/footer" . }}
{{ end }}

