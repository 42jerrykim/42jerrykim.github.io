{{ define "body-class" }}template-search{{ end }}

{{ define "head" }}
    <!-- Pagefind ë¦¬ì†ŒìŠ¤ -->
    <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
    
    <!-- ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ë¦¬ì†ŒìŠ¤ íŒíŠ¸ -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="/pagefind/" crossorigin>
    
    <style>
        /* ========================================
         * ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ CSS
         * ======================================== */
        
        /* ê²€ìƒ‰ ê²°ê³¼ ì»¨í…Œì´ë„ˆ */
        .search-results-container {
            margin-top: 2rem;
        }
        
        /* ê²€ìƒ‰ ê²°ê³¼ ì•„ì´í…œ - ê³ ì • ë ˆì´ì•„ì›ƒ */
        .search-result-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--card-separator-color, #ddd);
            min-height: 120px; /* ìµœì†Œ ë†’ì´ ê³ ì • */
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* ì´ë¯¸ì§€ ì˜ì—­ - ê³ ì • í¬ê¸°ë¡œ ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ */
        .search-result-image {
            width: 120px;
            height: 120px;
            flex-shrink: 0; /* í¬ê¸° ê³ ì • */
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--card-background, #f8f9fa);
            border: 1px solid var(--card-separator-color, #ddd);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .search-result-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }
        
        /* ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ */
        .search-result-image.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
                background-size: 400% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        
        /* ì´ë¯¸ì§€ ì—†ìŒ ìƒíƒœ */
        .search-result-image.no-image {
            background-color: var(--card-background, #f8f9fa);
            color: var(--card-text-color-secondary, #6c757d);
            font-size: 12px;
            text-align: center;
            padding: 8px;
        }
        
        /* ìŠ¤ì¼ˆë ˆí†¤ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes skeleton-loading {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        /* ì»¨í…ì¸  ì˜ì—­ */
        .search-result-content {
            flex: 1;
            min-width: 0; /* flexbox ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .search-result-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--card-text-color-main, #1a1a1a);
            text-decoration: none;
            margin-bottom: 0.8rem;
            line-height: 1.3;
        }
        
        .search-result-title:hover {
            color: var(--accent-color, #007acc);
            text-decoration: underline;
        }
        
        .search-result-excerpt {
            color: var(--card-text-color-secondary, #6b6b6b);
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .search-result-excerpt mark {
            background-color: var(--accent-color-lighter, rgba(0, 122, 204, 0.1));
            color: var(--accent-color, #007acc);
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .search-result-meta {
            font-size: 0.8rem;
            color: var(--card-text-color-tertiary, #999);
        }
        
        /* ì†Œì œëª©(sub-results) ìŠ¤íƒ€ì¼ */
        .search-result-sub {
            margin-top: 0.8rem;
        }
        
        .search-result-sub-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--card-text-color-main, #1a1a1a);
            margin-bottom: 0.3rem;
            text-decoration: none;
            line-height: 1.4;
        }
        
        .search-result-sub-title:hover {
            color: var(--accent-color, #007acc);
            text-decoration: underline;
        }
        
        .search-result-sub-excerpt {
            font-size: 1rem;
            color: var(--card-text-color-secondary, #6b6b6b);
            line-height: 1.5;
        }
        
        /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .search-result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }
        
        .search-result-tag {
            background: var(--tag-background-color, rgba(0, 122, 204, 0.1));
            color: var(--tag-text-color, var(--accent-color, #007acc));
            padding: 0.3em 0.8em;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .search-result-tag:hover {
            background: var(--tag-background-color-hover, var(--accent-color, #007acc));
            color: var(--tag-text-color-hover, #ffffff);
        }
        
        /* ë‹¤í¬ëª¨ë“œ ì§€ì› */
        @media (prefers-color-scheme: dark) {
            .search-result-image {
                background-color: var(--card-background, #2a2a2a);
                border-color: var(--card-separator-color, #444);
            }
            
            .search-result-image.loading {
                background: linear-gradient(90deg, #404040 25%, transparent 37%, #404040 63%);
                background-size: 400% 100%;
            }
            
            .search-result-image.no-image {
                background-color: var(--card-background, #2a2a2a);
                color: var(--card-text-color-secondary, #a0a0a0);
            }
            
            .search-result-title {
                color: var(--card-text-color-main, #ffffff);
            }
            
            .search-result-title:hover {
                color: var(--accent-color, #4a9eff);
            }
            
            .search-result-excerpt {
                color: var(--card-text-color-secondary, #999);
            }
            
            .search-result-excerpt mark {
                background-color: var(--accent-color-lighter, rgba(74, 158, 255, 0.2));
                color: var(--accent-color, #4a9eff);
            }
            
            .search-result-sub-title {
                color: var(--card-text-color-main, #ffffff);
            }
            
            .search-result-sub-title:hover {
                color: var(--accent-color, #4a9eff);
            }
            
            .search-result-sub-excerpt {
                color: var(--card-text-color-secondary, #999);
            }
        }
        
        /* ì‚¬ì´íŠ¸ í…Œë§ˆ ë‹¤í¬ëª¨ë“œ ì§€ì› */
        [data-scheme="dark"] .search-result-image,
        .dark .search-result-image,
        body.dark .search-result-image {
            background-color: var(--card-background, #2a2a2a) !important;
            border-color: var(--card-separator-color, #444) !important;
        }
        
        [data-scheme="dark"] .search-result-image.loading,
        .dark .search-result-image.loading,
        body.dark .search-result-image.loading {
            background: linear-gradient(90deg, #404040 25%, transparent 37%, #404040 63%) !important;
            background-size: 400% 100% !important;
        }
        
        [data-scheme="dark"] .search-result-image.no-image,
        .dark .search-result-image.no-image,
        body.dark .search-result-image.no-image {
            color: var(--card-text-color-secondary, #a0a0a0) !important;
        }
        
        [data-scheme="dark"] .search-result-title,
        .dark .search-result-title,
        body.dark .search-result-title {
            color: var(--card-text-color-main, #ffffff) !important;
        }
        
        [data-scheme="dark"] .search-result-title:hover,
        .dark .search-result-title:hover,
        body.dark .search-result-title:hover {
            color: var(--accent-color, #4a9eff) !important;
        }
        
        [data-scheme="dark"] .search-result-sub-title,
        .dark .search-result-sub-title,
        body.dark .search-result-sub-title {
            color: var(--card-text-color-main, #ffffff) !important;
        }
        
        [data-scheme="dark"] .search-result-sub-title:hover,
        .dark .search-result-sub-title:hover,
        body.dark .search-result-sub-title:hover {
            color: var(--accent-color, #4a9eff) !important;
        }
        
        [data-scheme="dark"] .search-result-sub-excerpt,
        .dark .search-result-sub-excerpt,
        body.dark .search-result-sub-excerpt {
            color: var(--card-text-color-secondary, #999) !important;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .search-result-item {
                flex-direction: column;
                min-height: 200px;
            }
            
            .search-result-image {
                width: 100%;
                height: 180px;
                margin-bottom: 1rem;
            }
            
            .search-result-title {
                font-size: 1.5rem;
            }
            
            .search-result-sub-title {
                font-size: 0.85rem;
            }
        }
        
        /* Pagefind UI ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
        .pagefind-ui__search-input {
            display: none !important;
        }
        
        .pagefind-ui__results {
            margin: 0;
        }
        
        .pagefind-ui__result {
            display: none !important; /* ê¸°ë³¸ ê²°ê³¼ ìˆ¨ê¸°ê¸° */
        }
        
        .pagefind-ui__message {
            text-align: center;
            color: var(--card-text-color-secondary, #6b6b6b);
            font-style: italic;
            margin: 2rem 0;
            font-size: 1.1rem;
        }
        
        .pagefind-ui__button {
            background: var(--accent-color, #007acc);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1.5rem auto;
            display: block;
        }
        
        .pagefind-ui__button:hover {
            background: var(--accent-color-darker, #005a99);
            transform: translateY(-1px);
        }
        
        /* ê²€ìƒ‰ ê²°ê³¼ ì œëª© */
        .search-result--title {
            display: none;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--card-text-color-main, #1a1a1a);
            margin-bottom: 1.5rem;
        }
        
        .search-result--title.show {
            display: block;
        }
        
        /* ë‹¤í¬ëª¨ë“œì—ì„œ ê²€ìƒ‰ ê²°ê³¼ ì œëª© */
        @media (prefers-color-scheme: dark) {
            .search-result--title {
                color: var(--card-text-color-main, #ffffff);
            }
        }
        
        [data-scheme="dark"] .search-result--title,
        .dark .search-result--title,
        body.dark .search-result--title {
            color: var(--card-text-color-main, #ffffff) !important;
        }
    </style>
{{ end }}

{{ define "main" }}
<form class="search-form" onsubmit="return false;">
    <p>
        <label>{{ T "search.title" }}</label>
        <input id="pagefind-search-input" name="keyword" placeholder="{{ T `search.placeholder` }}" />
    </p>
    <button type="button" title="{{ T `search.title` }}" onclick="performSearch()">
        {{ partial "helper/icon" "search" }}
    </button>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list">
        <!-- Pagefind UIê°€ ì—¬ê¸°ì— ì‚½ì…ë¨ (ìˆ¨ê²¨ì§) -->
        <div id="pagefind-search" style="display: none;"></div>
        <!-- ì»¤ìŠ¤í…€ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
        <div id="custom-search-results" class="search-results-container"></div>
    </div>
</div>

<script>
/**
 * ê°„ì†Œí™”ëœ Pagefind ê²€ìƒ‰ í˜ì´ì§€
 * - ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ì™„ì „ ë°©ì§€
 * - ê³ ì •ëœ ì´ë¯¸ì§€ ì˜ì—­
 * - ê°„ë‹¨í•˜ê³  ëª…í™•í•œ ì½”ë“œ êµ¬ì¡°
 */

// ========================================
// ì „ì—­ ë³€ìˆ˜
// ========================================
let pagefindInstance;
const imageCache = new Map();

// ì„±ëŠ¥ ìµœì í™”ìš© ë³€ìˆ˜ë“¤
let convertPagefindResultsTimeout = null;
let lastProcessedResultsCount = 0;
let isConverting = false;
const processedUrls = new Set();

// ========================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// ========================================

/**
 * Debounce í•¨ìˆ˜ - ì—°ì†ì ì¸ í˜¸ì¶œì„ ë°©ì§€
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * ë‹¤í¬ëª¨ë“œ ê°ì§€
 */
function isDarkMode() {
    return document.documentElement.getAttribute('data-scheme') === 'dark' || 
                      document.documentElement.classList.contains('dark') || 
                      document.body.classList.contains('dark') ||
                      window.matchMedia('(prefers-color-scheme: dark)').matches;
}

/**
 * ì´ë¯¸ì§€ URL ìƒì„±
 */
function generateImageCandidates(pageUrl) {
        const url = new URL(pageUrl, window.location.origin);
        const basePath = url.pathname.endsWith('/') ? url.pathname.slice(0, -1) : url.pathname;
    
    return [
        `${basePath}/poster.webp`,
        `${basePath}/poster.jpg`,
        `${basePath}/poster.png`,
        `${basePath}/image.webp`,
        `${basePath}/image.jpg`,
        `${basePath}/image.png`
    ];
}

/**
 * Pagefind ë©”íƒ€ë°ì´í„°ì—ì„œ ì´ë¯¸ì§€ URL ì¶”ì¶œ
 */
function extractImageFromPagefindMeta(result) {
    console.log('ğŸ” extractImageFromPagefindMeta í˜¸ì¶œë¨:', result);
    
    // Pagefind ê²°ê³¼ì˜ ë©”íƒ€ë°ì´í„°ì—ì„œ ì´ë¯¸ì§€ ì •ë³´ í™•ì¸
    if (result.meta && result.meta.image) {
        let imageUrl = result.meta.image.trim();
        console.log('ğŸ“¸ ì›ë³¸ ì´ë¯¸ì§€ URL:', imageUrl);
        
        // ë¹ˆ ë¬¸ìì—´ì´ ì•„ë‹Œì§€ í™•ì¸
        if (!imageUrl) {
            console.log('âŒ ë¹ˆ ì´ë¯¸ì§€ URL');
            return null;
        }
        
        // ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
        if (imageUrl.startsWith('/')) {
            imageUrl = window.location.origin + imageUrl;
            console.log('ğŸ”„ ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜:', imageUrl);
        } else if (!imageUrl.startsWith('http')) {
            // í”„ë¡œí† ì½œì´ ì—†ëŠ” ê²½ìš° ìƒëŒ€ ê²½ë¡œë¡œ ê°„ì£¼
            imageUrl = window.location.origin + '/' + imageUrl.replace(/^\/+/, '');
            console.log('ğŸ”„ í”„ë¡œí† ì½œ ì—†ëŠ” ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜:', imageUrl);
        }
        
        console.log('âœ… ìµœì¢… ì´ë¯¸ì§€ URL:', imageUrl);
        return imageUrl;
    }
    
    console.log('âŒ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì—†ìŒ');
    return null;
}

/**
 * ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
 */
async function checkImageExists(imageUrl) {
    console.log('ğŸ” checkImageExists í˜¸ì¶œë¨:', imageUrl);
    try {
        const response = await fetch(imageUrl, { method: 'HEAD' });
        const exists = response.ok;
        console.log('ğŸ” ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ ê²°ê³¼:', exists, 'ìƒíƒœ ì½”ë“œ:', response.status);
        return exists;
    } catch (error) {
        console.log('âŒ ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ ì‹¤íŒ¨:', error);
        return false;
    }
}

/**
 * í˜ì´ì§€ì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
 */
async function findImageInPage(pageUrl) {
    // ìºì‹œ í™•ì¸
    if (imageCache.has(pageUrl)) {
        return imageCache.get(pageUrl);
    }
    
    try {
        // 1. ê¸°ë³¸ í›„ë³´ ì´ë¯¸ì§€ í™•ì¸
        // const candidates = generateImageCandidates(pageUrl);
        // for (const candidate of candidates) {
        //     if (await checkImageExists(candidate)) {
        //         imageCache.set(pageUrl, candidate);
        //         return candidate;
        //     }
        // }
        
        // 2. í˜ì´ì§€ íŒŒì‹±í•´ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(pageUrl, { 
            signal: controller.signal,
            cache: 'force-cache'
        });
        clearTimeout(timeoutId);
        
        if (response.ok) {
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
            // article ë‚´ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì°¾ê¸°
            const articleImg = doc.querySelector('article img, .article-content img, .content img, main img');
            if (articleImg) {
            let src = articleImg.src || articleImg.getAttribute('src') || articleImg.getAttribute('data-src');
                if (src && !src.includes('avatar') && !src.includes('favicon')) {
            if (src.startsWith('/')) {
                src = window.location.origin + src;
            }
                    imageCache.set(pageUrl, src);
            return src;
                }
            }
        }
        
        // ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
        imageCache.set(pageUrl, null);
        return null;
    } catch (error) {
            console.warn('ì´ë¯¸ì§€ ê²€ìƒ‰ ì‹¤íŒ¨:', pageUrl, error.message);
        imageCache.set(pageUrl, null);
        return null;
    }
}

// ========================================
// ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
// ========================================

/**
 * ì»¤ìŠ¤í…€ ê²€ìƒ‰ ê²°ê³¼ ìƒì„±
 */
function createCustomSearchResult(result) {
    const resultElement = document.createElement('div');
    resultElement.className = 'search-result-item';
    
    // ì´ë¯¸ì§€ ì˜ì—­ (ê³ ì • í¬ê¸°)
    const imageDiv = document.createElement('div');
    imageDiv.className = 'search-result-image loading';
    imageDiv.href = result.url;
    imageDiv.innerHTML = '<div>ì´ë¯¸ì§€ ë¡œë”© ì¤‘...</div>';
    
    // ì»¨í…ì¸  ì˜ì—­
    const contentDiv = document.createElement('div');
    contentDiv.className = 'search-result-content';
    
    // ì œëª©
    const titleLink = document.createElement('a');
    titleLink.className = 'search-result-title';
    titleLink.href = result.url;
    titleLink.textContent = result.meta?.title || 'ì œëª© ì—†ìŒ';
    
    // ìš”ì•½
    const excerptDiv = document.createElement('div');
    excerptDiv.className = 'search-result-excerpt';
    excerptDiv.innerHTML = result.excerpt || '';
    
    // ë©”íƒ€ ì •ë³´
    const metaDiv = document.createElement('div');
    metaDiv.className = 'search-result-meta';
    metaDiv.textContent = new URL(result.url).pathname;
    
    // DOM ìš”ì†Œë“¤ì„ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ì¶”ê°€
    contentDiv.appendChild(titleLink);  // 1. ì œëª© ë¨¼ì €
    contentDiv.appendChild(excerptDiv); // 2. ìš”ì•½
    
    // ì†Œì œëª©ë“¤ (sub-results) ì²˜ë¦¬
    if (result.sub_results && result.sub_results.length > 0) {
        result.sub_results.forEach(subResult => {
            const subDiv = document.createElement('div');
            subDiv.className = 'search-result-sub';
            
            const subTitleLink = document.createElement('a');
            subTitleLink.className = 'search-result-sub-title';
            subTitleLink.href = subResult.url;
            subTitleLink.textContent = subResult.title || 'ì†Œì œëª©';
            
            const subExcerptDiv = document.createElement('div');
            subExcerptDiv.className = 'search-result-sub-excerpt';
            subExcerptDiv.innerHTML = subResult.excerpt || '';
            
            subDiv.appendChild(subTitleLink);
            if (subResult.excerpt) {
                subDiv.appendChild(subExcerptDiv);
            }
            
            contentDiv.appendChild(subDiv);  // 3. ì†Œì œëª©ë“¤
        });
    }
    
    // íƒœê·¸ë“¤ ì²˜ë¦¬
    if (result.meta?.tags && result.meta.tags.length > 0) {
        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'search-result-tags';
        
        result.meta.tags.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'search-result-tag';
            tagSpan.textContent = tag;
            tagsDiv.appendChild(tagSpan);
        });
        
        contentDiv.appendChild(tagsDiv);  // 4. íƒœê·¸ë“¤
    }
    
    contentDiv.appendChild(metaDiv);    // 5. ë§ˆì§€ë§‰ì— ë©”íƒ€ ì •ë³´
    
    resultElement.appendChild(imageDiv);
    resultElement.appendChild(contentDiv);
    
    // ì´ë¯¸ì§€ ë¡œë”© ì‹œì‘ (Pagefind ë©”íƒ€ë°ì´í„° ìš°ì„  ì‚¬ìš©)
    console.log('ğŸ–¼ï¸ loadImageForResult í˜¸ì¶œ ì¤€ë¹„:', {
        resultUrl: result.url,
        metaImage: result.meta?.image,
        imageDiv: !!imageDiv
    });
    loadImageForResult(imageDiv, result.url, result.meta?.image);
    
    return resultElement;
}

/**
 * ê²°ê³¼ì— ì´ë¯¸ì§€ ë¡œë”©
 */
async function loadImageForResult(imageDiv, pageUrl, metaImage) {
    console.log('ğŸ–¼ï¸ loadImageForResult í˜¸ì¶œë¨:', { pageUrl, metaImage });
    
    try {
        let imageUrl = null;
        
        // 1. Pagefind ë©”íƒ€ë°ì´í„° ì´ë¯¸ì§€ ìš°ì„  í™•ì¸
        if (metaImage) {
            console.log('ğŸ“¸ ë©”íƒ€ë°ì´í„° ì´ë¯¸ì§€ ì‚¬ìš©:', metaImage);
            // ì´ë¯¸ ì ˆëŒ€ ê²½ë¡œì¸ì§€ í™•ì¸
            imageUrl = metaImage.startsWith('http') ? metaImage : 
                      metaImage.startsWith('/') ? window.location.origin + metaImage : metaImage;
            
            console.log('ğŸ”— ë³€í™˜ëœ ì´ë¯¸ì§€ URL:', imageUrl);
            
            if (await checkImageExists(imageUrl)) {
                console.log('âœ… ë©”íƒ€ë°ì´í„° ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ë¨');
                loadImageSuccess(imageDiv, imageUrl);
                return;
            } else {
                console.log('âŒ ë©”íƒ€ë°ì´í„° ì´ë¯¸ì§€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
            }
        } else {
            console.log('âŒ ë©”íƒ€ë°ì´í„° ì´ë¯¸ì§€ ì—†ìŒ');
        }
        
        // 2. í˜ì´ì§€ì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸° (fallback)
        // imageUrl = await findImageInPage(pageUrl);
        
        if (imageUrl) {
            loadImageSuccess(imageDiv, imageUrl);
        } else {
            console.log('âŒ ì´ë¯¸ì§€ URL ì—†ìŒ, ì‹¤íŒ¨ ì²˜ë¦¬');
            loadImageFailed(imageDiv);
        }
    } catch (error) {
        console.warn('ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨:', pageUrl, error);
        loadImageFailed(imageDiv);
    }
}

/**
 * ì´ë¯¸ì§€ ë¡œë”© ì„±ê³µ
 */
function loadImageSuccess(imageDiv, imageUrl) {
    console.log('âœ… loadImageSuccess í˜¸ì¶œë¨:', imageUrl);
    console.log('ğŸ–¼ï¸ imageDiv ìš”ì†Œ:', imageDiv);
    console.log('ğŸ–¼ï¸ imageDiv í˜„ì¬ í´ë˜ìŠ¤:', imageDiv.className);
    console.log('ğŸ–¼ï¸ imageDiv í˜„ì¬ HTML:', imageDiv.innerHTML);
    
    imageDiv.className = 'search-result-image';
    
    const img = document.createElement('img');
    img.alt = 'ê²€ìƒ‰ ê²°ê³¼ ì´ë¯¸ì§€';
    // lazy loading ì œê±° - ì¦‰ì‹œ ë¡œë”©
    // img.loading = 'lazy';
    
    console.log('ğŸ–¼ï¸ ìƒì„±ëœ img ìš”ì†Œ:', img);
    
    // ì´ë¯¸ì§€ ë¡œë”© íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆë¡œ ì—°ì¥)
    const timeoutId = setTimeout(() => {
        console.log('â° ì´ë¯¸ì§€ ë¡œë”© íƒ€ì„ì•„ì›ƒ:', imageUrl);
        loadImageFailed(imageDiv);
    }, 10000);
    
    // onload/onerror ì´ë²¤íŠ¸ ë¨¼ì € ì„¤ì •
    img.onload = () => {
        console.log('ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', imageUrl);
        console.log('ğŸ–¼ï¸ DOM ì—…ë°ì´íŠ¸ ì‹œì‘');
        clearTimeout(timeoutId); // íƒ€ì„ì•„ì›ƒ í•´ì œ
        imageDiv.innerHTML = '';
        imageDiv.appendChild(img);
        console.log('ğŸ–¼ï¸ ì´ë¯¸ì§€ ìš”ì†Œê°€ DOMì— ì¶”ê°€ë¨');
        console.log('ğŸ–¼ï¸ imageDiv ìµœì¢… HTML:', imageDiv.innerHTML);
    };
    
    img.onerror = () => {
        console.log('âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', imageUrl);
        clearTimeout(timeoutId); // íƒ€ì„ì•„ì›ƒ í•´ì œ
        loadImageFailed(imageDiv);
    };
    
    // ë§ˆì§€ë§‰ì— src ì„¤ì • (ì´ë²¤íŠ¸ ì„¤ì • í›„)
    console.log('ğŸ–¼ï¸ img.src ì„¤ì • ì‹œì‘:', imageUrl);
    img.src = imageUrl;
    console.log('ğŸ–¼ï¸ img.src ì„¤ì • ì™„ë£Œ:', img.src);
    
    // src ì„¤ì • í›„ ì¦‰ì‹œ ìºì‹œëœ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸
    setTimeout(() => {
        if (img.complete) {
            console.log('ğŸ–¼ï¸ ì´ë¯¸ì§€ê°€ ì¦‰ì‹œ ë¡œë”©ë¨ (ìºì‹œë¨), ì²˜ë¦¬ ì¤‘');
            clearTimeout(timeoutId);
            if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                console.log('ğŸ–¼ï¸ ìºì‹œëœ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', img.naturalWidth, 'x', img.naturalHeight);
                imageDiv.innerHTML = '';
                imageDiv.appendChild(img);
                console.log('ğŸ–¼ï¸ ìºì‹œëœ ì´ë¯¸ì§€ DOMì— ì¶”ê°€ ì™„ë£Œ');
            } else {
                console.log('âŒ ìºì‹œëœ ì´ë¯¸ì§€ í¬ê¸° ì •ë³´ ì—†ìŒ, ì¼ë°˜ ë¡œë”© ê³„ì†');
                // ìºì‹œëœ ì´ë¯¸ì§€ì— ë¬¸ì œê°€ ìˆìœ¼ë©´ ê°•ì œë¡œ ë‹¤ì‹œ ë¡œë”©
                const newSrc = img.src + '?t=' + Date.now();
                console.log('ğŸ”„ ì´ë¯¸ì§€ ê°•ì œ ì¬ë¡œë”© ì‹œë„:', newSrc);
                img.src = newSrc;
            }
        } else {
            console.log('ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¡œë”© ì¤‘, ì´ë²¤íŠ¸ ëŒ€ê¸°');
        }
    }, 10);
}

/**
 * ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨
 */
function loadImageFailed(imageDiv) {
    console.log('âŒ loadImageFailed í˜¸ì¶œë¨');
    console.log('ğŸ–¼ï¸ imageDiv ìš”ì†Œ:', imageDiv);
    console.log('ğŸ–¼ï¸ imageDiv ë³€ê²½ ì „ í´ë˜ìŠ¤:', imageDiv.className);
    console.log('ğŸ–¼ï¸ imageDiv ë³€ê²½ ì „ HTML:', imageDiv.innerHTML);
    
    imageDiv.className = 'search-result-image no-image';
    imageDiv.innerHTML = '<div>ì´ë¯¸ì§€ ì—†ìŒ</div>';
    
    console.log('ğŸ–¼ï¸ imageDiv ìµœì¢… í´ë˜ìŠ¤:', imageDiv.className);
    console.log('ğŸ–¼ï¸ imageDiv ìµœì¢… HTML:', imageDiv.innerHTML);
}

// ========================================
// ê²€ìƒ‰ ê¸°ëŠ¥
// ========================================

// ì¤‘ë³µ ê²€ìƒ‰ ë°©ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜
let currentSearchTerm = '';
let isSearching = false;

/**
 * ê²€ìƒ‰ ì‹¤í–‰
 */
function performSearch() {
    const searchTerm = document.getElementById('pagefind-search-input').value.trim();
    
    if (!searchTerm) {
        hideSearchResults();
        return;
    }
    
    // ë™ì¼í•œ ê²€ìƒ‰ì–´ë¡œ ì´ë¯¸ ê²€ìƒ‰ ì¤‘ì¸ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (isSearching && currentSearchTerm === searchTerm) {
        console.log('ë™ì¼í•œ ê²€ìƒ‰ì–´ë¡œ ì´ë¯¸ ê²€ìƒ‰ ì¤‘, ê±´ë„ˆëœ€:', searchTerm);
        return;
    }
    
    // ë™ì¼í•œ ê²€ìƒ‰ì–´ì¸ë° ì´ë¯¸ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš° ìŠ¤í‚µ
    const customResultsContainer = document.getElementById('custom-search-results');
    if (currentSearchTerm === searchTerm && customResultsContainer.children.length > 0) {
        console.log('ë™ì¼í•œ ê²€ìƒ‰ì–´ì˜ ê²°ê³¼ê°€ ì´ë¯¸ í‘œì‹œë¨, ê±´ë„ˆëœ€:', searchTerm);
        return;
    }
    
    // ê²€ìƒ‰ ì‹œì‘
    isSearching = true;
    
    // ìƒˆë¡œìš´ ê²€ìƒ‰ì–´ì¸ ê²½ìš°ì—ë§Œ ìƒíƒœ ì´ˆê¸°í™”
    if (currentSearchTerm !== searchTerm) {
        console.log('ìƒˆë¡œìš´ ê²€ìƒ‰ì–´ ê°ì§€, ìƒíƒœ ì´ˆê¸°í™”:', currentSearchTerm, '->', searchTerm);
        currentSearchTerm = searchTerm;
        processedUrls.clear();
        lastProcessedResultsCount = 0;
        isConverting = false;
        
        // ê¸°ì¡´ ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ê²€ìƒ‰ì–´ì¸ ê²½ìš°ì—ë§Œ)
        customResultsContainer.innerHTML = '';
    } else {
        console.log('ë™ì¼í•œ ê²€ìƒ‰ì–´ ì¬ì‹¤í–‰, ì´ˆê¸°í™” ìƒëµ:', searchTerm);
    }
    
    console.log(`ìƒˆ ê²€ìƒ‰ ì‹œì‘: "${searchTerm}"`);
        
    // ê²€ìƒ‰ ê²°ê³¼ ì œëª© ì—…ë°ì´íŠ¸
    updateSearchResultTitle(searchTerm);
    
    // Pagefind ê²€ìƒ‰ ì‹¤í–‰
    const pagefindInput = document.querySelector('.pagefind-ui__search-input');
    if (pagefindInput) {
        pagefindInput.value = searchTerm;
        pagefindInput.dispatchEvent(new Event('input'));
    }
    
    // ê²€ìƒ‰ ì™„ë£Œ í‘œì‹œ (ì•½ê°„ì˜ ì§€ì—° í›„)
    setTimeout(() => {
        isSearching = false;
    }, 1000);
}

/**
 * ê²€ìƒ‰ ê²°ê³¼ ì œëª© ì—…ë°ì´íŠ¸
 */
function updateSearchResultTitle(searchTerm) {
        const resultTitle = document.querySelector('.search-result--title');
    if (searchTerm) {
            resultTitle.textContent = `"${searchTerm}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼`;
        resultTitle.classList.add('show');
        } else {
        resultTitle.classList.remove('show');
    }
}

/**
 * ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
 */
function hideSearchResults() {
    const resultTitle = document.querySelector('.search-result--title');
    resultTitle.classList.remove('show');
    const customResultsContainer = document.getElementById('custom-search-results');
    customResultsContainer.innerHTML = '';
    
    // ìƒíƒœ ì´ˆê¸°í™”
    processedUrls.clear();
    lastProcessedResultsCount = 0;
    isConverting = false;
}

// ========================================
// ì´ˆê¸°í™”
// ========================================


// debounced ë²„ì „ì˜ convertPagefindResults ìƒì„±
const debouncedConvertResults = debounce(convertPagefindResults, 300);

document.addEventListener('DOMContentLoaded', function() {
    const customResultsContainer = document.getElementById('custom-search-results');
    
    // PagefindUI ì´ˆê¸°í™”
    pagefindInstance = new PagefindUI({ 
        element: "#pagefind-search",
        showSubResults: true,
        showEmptyFilters: true,
        resetStyles: false,
        autofocus: false,
        processResult: function(result) {
            // ì‘ì„±ì ì •ë³´ ì •ë¦¬
            if (result.meta?.author === "42jerrykim") {
                delete result.meta.author;
            }
            
            // ì œëª© ì •ë¦¬
            if (result.meta?.title) {
                result.meta.title = result.meta.title.trim();
            }
            
            // ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì²˜ë¦¬
            if (result.meta?.image) {
                // ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
                if (result.meta.image.startsWith('/')) {
                    result.meta.image = window.location.origin + result.meta.image;
                }
            }
            
            return result;
        },
        translations: {
            placeholder: "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...",
            clear_search: "ê²€ìƒ‰ ì§€ìš°ê¸°",
            load_more: "ë” ë³´ê¸°",
            search_label: "ì‚¬ì´íŠ¸ ê²€ìƒ‰",
            filters_label: "í•„í„°",
            zero_results: "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤: [SEARCH_TERM]",
            many_results: "[COUNT]ê°œì˜ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤: [SEARCH_TERM]",
            one_result: "1ê°œì˜ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤: [SEARCH_TERM]",
            alt_search: "ê²€ìƒ‰: [SEARCH_TERM]",
            search_suggestion: "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
            searching: "ê²€ìƒ‰ ì¤‘..."
        }
    });
    
    // ê°œì„ ëœ Pagefind ê²°ê³¼ ê°ì§€ ë° ì»¤ìŠ¤í…€ ê²°ê³¼ë¡œ ë³€í™˜
    const observer = new MutationObserver(function(mutations) {
        let shouldUpdate = false;
        
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                // Pagefind ê²°ê³¼ë‚˜ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
                const addedNodes = Array.from(mutation.addedNodes);
                const hasRelevantChanges = addedNodes.some(node => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        return node.classList.contains('pagefind-ui__result') ||
                               node.classList.contains('pagefind-ui__message') ||
                               node.classList.contains('pagefind-ui__button') ||
                               node.querySelector('.pagefind-ui__result') ||
                               node.querySelector('.pagefind-ui__message') ||
                               node.querySelector('.pagefind-ui__button');
                    }
                    return false;
                });
                
                if (hasRelevantChanges) {
                    shouldUpdate = true;
                }
            }
        });
        
        if (shouldUpdate) {
            console.log("ê´€ë ¨ ë³€ê²½ì‚¬í•­ ê°ì§€ - Pagefind ê²°ê³¼ ì—…ë°ì´íŠ¸");
            debouncedConvertResults();
        }
    });
    
    // Pagefind ì»¨í…Œì´ë„ˆ ê´€ì°°
    const pagefindContainer = document.getElementById('pagefind-search');
    if (pagefindContainer) {
        observer.observe(pagefindContainer, { childList: true, subtree: true });
    }
    
    // ì»¤ìŠ¤í…€ ê²€ìƒ‰ ì…ë ¥ê³¼ PagefindUI ì—°ê²°
    const customInput = document.getElementById('pagefind-search-input');
    customInput.addEventListener('input', performSearch);
    customInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²€ìƒ‰ì–´ ì¶”ì¶œ
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('keyword') || urlParams.get('q') || urlParams.get('search');
    
    if (searchQuery) {
        customInput.value = searchQuery;
        setTimeout(performSearch, 500);
    }
});

/**
 * Pagefind ê²°ê³¼ë¥¼ ì»¤ìŠ¤í…€ ê²°ê³¼ë¡œ ë³€í™˜ (ìµœì í™”ëœ ë²„ì „)
 */
async function convertPagefindResults() {
    // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (isConverting) {
        console.log('convertPagefindResults ì´ë¯¸ ì‹¤í–‰ ì¤‘, ê±´ë„ˆëœ€');
        return;
    }
    
    isConverting = true;
    
    try {
        const customResultsContainer = document.getElementById('custom-search-results');
        console.log('convertPagefindResults ì‹¤í–‰ ì‹œì‘');
        
        // Pagefind ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
        const pagefindResults = document.querySelectorAll('#pagefind-search .pagefind-ui__result');
        
        // ê²°ê³¼ ê°œìˆ˜ê°€ ì´ì „ê³¼ ê°™ìœ¼ë©´ ìŠ¤í‚µ (ì¶”ê°€ ìµœì í™”)
        if (pagefindResults.length === lastProcessedResultsCount && pagefindResults.length > 0) {
            console.log('ê²°ê³¼ ê°œìˆ˜ ë™ì¼, ë³€í™˜ ê±´ë„ˆëœ€');
            isConverting = false;
            return;
        }
        
        if (pagefindResults.length === 0) {
            // ë©”ì‹œì§€ ì²˜ë¦¬ (ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë“±)
            const message = document.querySelector('#pagefind-search .pagefind-ui__message');
            if (message) {
                customResultsContainer.innerHTML = '';
                const customMessage = message.cloneNode(true);
                customResultsContainer.appendChild(customMessage);
            }
            lastProcessedResultsCount = 0;
            processedUrls.clear();
            isConverting = false;
            return;
        }
        
        console.log(`Pagefind ê²°ê³¼ ${pagefindResults.length}ê°œ ì²˜ë¦¬ ì‹œì‘`);
        
        // ìƒˆë¡œìš´ ê²€ìƒ‰ì¸ ê²½ìš° ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” (ì´ë¯¸ performSearchì—ì„œ ì²˜ë¦¬ë˜ì—ˆì§€ë§Œ ì¶”ê°€ ë³´ì¥)
        if (pagefindResults.length > 0 && customResultsContainer.children.length === 0) {
            customResultsContainer.innerHTML = '';
        }
        
        // ìƒˆë¡œìš´ ê²°ê³¼ë§Œ ì¶”ê°€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ìµœì í™”
        let addedCount = 0;
        
        // ê° ê²°ê³¼ë¥¼ ì»¤ìŠ¤í…€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        for (const pagefindResult of pagefindResults) {
            try {
                // Pagefind ê²°ê³¼ì—ì„œ ë°ì´í„° ì¶”ì¶œ
                const titleElement = pagefindResult.querySelector('.pagefind-ui__result-link');
                const excerptElement = pagefindResult.querySelector('.pagefind-ui__result-excerpt');
                const subResultElements = pagefindResult.querySelectorAll('.pagefind-ui__result-nested');
                const tagElements = pagefindResult.querySelectorAll('.pagefind-ui__result-tag');
                
                if (!titleElement) continue;
                
                const resultUrl = titleElement.href;
                
                // ì´ë¯¸ ì²˜ë¦¬ëœ URLì¸ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€) - ìƒˆ ê²€ìƒ‰ì˜ ê²½ìš°ëŠ” skip
                if (processedUrls.has(resultUrl)) {
                    console.log('ì¤‘ë³µ URL ìŠ¤í‚µ:', resultUrl);
                    continue;
                }
                
                console.log('ìƒˆ ê²°ê³¼ ì²˜ë¦¬:', resultUrl);
                
                // ì†Œì œëª©ë“¤ ì¶”ì¶œ
                const subResults = [];
                subResultElements.forEach(subElement => {
                    const subTitleEl = subElement.querySelector('.pagefind-ui__result-link');
                    const subExcerptEl = subElement.querySelector('.pagefind-ui__result-excerpt');
                    
                    if (subTitleEl) {
                        subResults.push({
                            title: subTitleEl.textContent.trim(),
                            url: subTitleEl.href,
                            excerpt: subExcerptEl ? subExcerptEl.innerHTML : ''
                        });
                    }
                });
                
                // íƒœê·¸ë“¤ ì¶”ì¶œ
                const tags = [];
                tagElements.forEach(tagEl => {
                    const tagText = tagEl.textContent.trim();
                    if (tagText) {
                        tags.push(tagText);
                    }
                });
                
                // Pagefind ê²°ê³¼ì—ì„œ ì´ë¯¸ì§€ ì •ë³´ ì¶”ì¶œ (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)
                let pagefindImage = null;
                
                // ë°©ë²• 1: Pagefindê°€ ë Œë”ë§í•œ <img> íƒœê·¸ì—ì„œ ì§ì ‘ ì¶”ì¶œ
                const pagefindImgElement = pagefindResult.querySelector('img.pagefind-ui__result-image');
                if (pagefindImgElement && pagefindImgElement.src) {
                    pagefindImage = pagefindImgElement.src;
                    console.log('ğŸ“¸ ë°©ë²• 1 - <img> íƒœê·¸ì—ì„œ ì¶”ì¶œëœ ì´ë¯¸ì§€ URL:', pagefindImage);
                }
                
                // ë°©ë²• 2: data-pagefind-meta="image" ìš”ì†Œì—ì„œ ì¶”ì¶œ (fallback)
                if (!pagefindImage) {
                    const imageMetaElement = pagefindResult.querySelector('[data-pagefind-meta="image"]');
                    if (imageMetaElement) {
                        const imageText = imageMetaElement.textContent.trim();
                        if (imageText) {
                            pagefindImage = extractImageFromPagefindMeta({
                                meta: { image: imageText }
                            });
                            console.log('ğŸ“¸ ë°©ë²• 2 - data-pagefind-metaì—ì„œ ì¶”ì¶œëœ ì´ë¯¸ì§€ URL:', pagefindImage);
                        }
                    }
                }
                
                // ë°©ë²• 3: pagefind-image-hidden í´ë˜ìŠ¤ì—ì„œ ì¶”ì¶œ (fallback)
                if (!pagefindImage) {
                    const hiddenImageElement = pagefindResult.querySelector('.pagefind-image-hidden');
                    if (hiddenImageElement) {
                        const imageText = hiddenImageElement.textContent.trim();
                        if (imageText) {
                            pagefindImage = extractImageFromPagefindMeta({
                                meta: { image: imageText }
                            });
                            console.log('ğŸ“¸ ë°©ë²• 3 - pagefind-image-hiddenì—ì„œ ì¶”ì¶œëœ ì´ë¯¸ì§€ URL:', pagefindImage);
                        }
                    }
                }
                
                // ë°©ë²• 4: ëª¨ë“  data-pagefind-meta ì†ì„±ì„ ê°€ì§„ ìš”ì†Œ í™•ì¸ (fallback)
                if (!pagefindImage) {
                    const allMetaElements = pagefindResult.querySelectorAll('[data-pagefind-meta]');
                    allMetaElements.forEach(el => {
                        const key = el.getAttribute('data-pagefind-meta');
                        if (key === 'image' && !pagefindImage) {
                            const imageText = el.textContent.trim();
                            if (imageText) {
                                pagefindImage = extractImageFromPagefindMeta({
                                    meta: { image: imageText }
                                });
                                console.log('ğŸ“¸ ë°©ë²• 4 - ë©”íƒ€ë°ì´í„°ì—ì„œ ì¶”ì¶œëœ ì´ë¯¸ì§€ URL:', pagefindImage);
                            }
                        }
                    });
                }
                
                const result = {
                    url: resultUrl,
                    meta: {
                        title: titleElement.textContent.trim(),
                        tags: tags.length > 0 ? tags : undefined,
                        image: pagefindImage
                    },
                    excerpt: excerptElement ? excerptElement.innerHTML : '',
                    sub_results: subResults.length > 0 ? subResults : undefined
                };
                
                // ì»¤ìŠ¤í…€ ê²°ê³¼ ìƒì„± ë° ì¶”ê°€
                console.log('createCustomSearchResult í˜¸ì¶œ ì‹œì‘:', resultUrl);
                const customResult = createCustomSearchResult(result);
                console.log('createCustomSearchResult ì™„ë£Œ:', !!customResult, customResult ? customResult.className : 'no element');
                
                if (customResult) {
                    console.log('DOMì— ì¶”ê°€ ì‹œì‘');
                    customResultsContainer.appendChild(customResult);
                    console.log('DOMì— ì¶”ê°€ ì™„ë£Œ, í˜„ì¬ children count:', customResultsContainer.children.length);
                } else {
                    console.error('createCustomSearchResultê°€ null ë°˜í™˜');
                }
                
                // ì²˜ë¦¬ëœ URL ê¸°ë¡
                processedUrls.add(resultUrl);
                addedCount++;
                
            } catch (error) {
                console.warn('ê²°ê³¼ ë³€í™˜ ì‹¤íŒ¨:', error);
            }
        }
        
        console.log(`ìƒˆë¡œìš´ ê²°ê³¼ ${addedCount}ê°œ ì¶”ê°€ë¨`);
        
        // "ë” ë³´ê¸°" ë²„íŠ¼ ì²˜ë¦¬ (ê¸°ì¡´ ë²„íŠ¼ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€)
        const existingLoadMoreButton = customResultsContainer.querySelector('.pagefind-ui__button');
        if (existingLoadMoreButton) {
            existingLoadMoreButton.remove();
        }
        
        const loadMoreButton = document.querySelector('#pagefind-search .pagefind-ui__button');
        if (loadMoreButton) {
            const customLoadMoreButton = loadMoreButton.cloneNode(true);
            customLoadMoreButton.onclick = () => {
                loadMoreButton.click();
                console.log("ë” ë³´ê¸° ë²„íŠ¼ í´ë¦­");
                // debounceë¥¼ ì ìš©í•œ í˜¸ì¶œ
                debouncedConvertResults();
            };
            customResultsContainer.appendChild(customLoadMoreButton);
        }
        
        lastProcessedResultsCount = pagefindResults.length;
        
    } catch (error) {
        console.error('convertPagefindResults ì‹¤í–‰ ì‹¤íŒ¨:', error);
    } finally {
        isConverting = false;
    }
}

// ì „ì—­ ì ‘ê·¼ì„ ìœ„í•œ ë³„ì¹­
window.performSearch = performSearch;
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1523508823345999"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-1523508823345999"
     data-ad-slot="2764508212"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
{{ partialCached "footer/footer" . }}
{{ end }}
