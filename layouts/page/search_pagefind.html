{{ define "body-class" }}template-search{{ end }}

{{ define "head" }}
    <!-- Pagefind 리소스 -->
    <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
    
    <!-- 성능 최적화를 위한 리소스 힌트 -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="/pagefind/" crossorigin>
    
    <style>
        /* ========================================
         * 레이아웃 시프트 방지 CSS
         * ======================================== */
        
        /* 검색 결과 컨테이너 */
        .search-results-container {
            margin-top: 2rem;
        }
        
        /* 검색 결과 아이템 - 고정 레이아웃 */
        .search-result-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--card-separator-color, #ddd);
            min-height: 120px; /* 최소 높이 고정 */
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* 이미지 영역 - 고정 크기로 레이아웃 시프트 방지 */
        .search-result-image {
            width: 120px;
            height: 120px;
            flex-shrink: 0; /* 크기 고정 */
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--card-background, #f8f9fa);
            border: 1px solid var(--card-separator-color, #ddd);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .search-result-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }
        
        /* 이미지 로딩 상태 */
        .search-result-image.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
                background-size: 400% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        
        /* 이미지 없음 상태 */
        .search-result-image.no-image {
            background-color: var(--card-background, #f8f9fa);
            color: var(--card-text-color-secondary, #6c757d);
            font-size: 12px;
            text-align: center;
            padding: 8px;
        }
        
        /* 스켈레톤 로딩 애니메이션 */
        @keyframes skeleton-loading {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        /* 컨텐츠 영역 */
        .search-result-content {
            flex: 1;
            min-width: 0; /* flexbox 오버플로우 방지 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .search-result-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--card-text-color-main, #1a1a1a);
            text-decoration: none;
            margin-bottom: 0.8rem;
            line-height: 1.3;
        }
        
        .search-result-title:hover {
            color: var(--accent-color, #007acc);
            text-decoration: underline;
        }
        
        .search-result-excerpt {
            color: var(--card-text-color-secondary, #6b6b6b);
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .search-result-excerpt mark {
            background-color: var(--accent-color-lighter, rgba(0, 122, 204, 0.1));
            color: var(--accent-color, #007acc);
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .search-result-meta {
            font-size: 0.8rem;
            color: var(--card-text-color-tertiary, #999);
        }
        
        /* 소제목(sub-results) 스타일 */
        .search-result-sub {
            margin-top: 0.8rem;
        }
        
        .search-result-sub-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--card-text-color-main, #1a1a1a);
            margin-bottom: 0.3rem;
            text-decoration: none;
            line-height: 1.4;
        }
        
        .search-result-sub-title:hover {
            color: var(--accent-color, #007acc);
            text-decoration: underline;
        }
        
        .search-result-sub-excerpt {
            font-size: 1rem;
            color: var(--card-text-color-secondary, #6b6b6b);
            line-height: 1.5;
        }
        
        /* 태그 스타일 */
        .search-result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }
        
        .search-result-tag {
            background: var(--tag-background-color, rgba(0, 122, 204, 0.1));
            color: var(--tag-text-color, var(--accent-color, #007acc));
            padding: 0.3em 0.8em;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .search-result-tag:hover {
            background: var(--tag-background-color-hover, var(--accent-color, #007acc));
            color: var(--tag-text-color-hover, #ffffff);
        }
        
        /* 다크모드 지원 */
        @media (prefers-color-scheme: dark) {
            .search-result-image {
                background-color: var(--card-background, #2a2a2a);
                border-color: var(--card-separator-color, #444);
            }
            
            .search-result-image.loading {
                background: linear-gradient(90deg, #404040 25%, transparent 37%, #404040 63%);
                background-size: 400% 100%;
            }
            
            .search-result-image.no-image {
                background-color: var(--card-background, #2a2a2a);
                color: var(--card-text-color-secondary, #a0a0a0);
            }
            
            .search-result-title {
                color: var(--card-text-color-main, #ffffff);
            }
            
            .search-result-title:hover {
                color: var(--accent-color, #4a9eff);
            }
            
            .search-result-excerpt {
                color: var(--card-text-color-secondary, #999);
            }
            
            .search-result-excerpt mark {
                background-color: var(--accent-color-lighter, rgba(74, 158, 255, 0.2));
                color: var(--accent-color, #4a9eff);
            }
            
            .search-result-sub-title {
                color: var(--card-text-color-main, #ffffff);
            }
            
            .search-result-sub-title:hover {
                color: var(--accent-color, #4a9eff);
            }
            
            .search-result-sub-excerpt {
                color: var(--card-text-color-secondary, #999);
            }
        }
        
        /* 사이트 테마 다크모드 지원 */
        [data-scheme="dark"] .search-result-image,
        .dark .search-result-image,
        body.dark .search-result-image {
            background-color: var(--card-background, #2a2a2a) !important;
            border-color: var(--card-separator-color, #444) !important;
        }
        
        [data-scheme="dark"] .search-result-image.loading,
        .dark .search-result-image.loading,
        body.dark .search-result-image.loading {
            background: linear-gradient(90deg, #404040 25%, transparent 37%, #404040 63%) !important;
            background-size: 400% 100% !important;
        }
        
        [data-scheme="dark"] .search-result-image.no-image,
        .dark .search-result-image.no-image,
        body.dark .search-result-image.no-image {
            color: var(--card-text-color-secondary, #a0a0a0) !important;
        }
        
        [data-scheme="dark"] .search-result-title,
        .dark .search-result-title,
        body.dark .search-result-title {
            color: var(--card-text-color-main, #ffffff) !important;
        }
        
        [data-scheme="dark"] .search-result-title:hover,
        .dark .search-result-title:hover,
        body.dark .search-result-title:hover {
            color: var(--accent-color, #4a9eff) !important;
        }
        
        [data-scheme="dark"] .search-result-sub-title,
        .dark .search-result-sub-title,
        body.dark .search-result-sub-title {
            color: var(--card-text-color-main, #ffffff) !important;
        }
        
        [data-scheme="dark"] .search-result-sub-title:hover,
        .dark .search-result-sub-title:hover,
        body.dark .search-result-sub-title:hover {
            color: var(--accent-color, #4a9eff) !important;
        }
        
        [data-scheme="dark"] .search-result-sub-excerpt,
        .dark .search-result-sub-excerpt,
        body.dark .search-result-sub-excerpt {
            color: var(--card-text-color-secondary, #999) !important;
        }
        
        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .search-result-item {
                flex-direction: column;
                min-height: 200px;
            }
            
            .search-result-image {
                width: 100%;
                height: 180px;
                margin-bottom: 1rem;
            }
            
            .search-result-title {
                font-size: 1.5rem;
            }
            
            .search-result-sub-title {
                font-size: 0.85rem;
            }
        }
        
        /* Pagefind UI 기본 스타일 오버라이드 */
        .pagefind-ui__search-input {
            display: none !important;
        }
        
        .pagefind-ui__results {
            margin: 0;
        }
        
        .pagefind-ui__result {
            display: none !important; /* 기본 결과 숨기기 */
        }
        
        .pagefind-ui__message {
            text-align: center;
            color: var(--card-text-color-secondary, #6b6b6b);
            font-style: italic;
            margin: 2rem 0;
            font-size: 1.1rem;
        }
        
        .pagefind-ui__button {
            background: var(--accent-color, #007acc);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1.5rem auto;
            display: block;
        }
        
        .pagefind-ui__button:hover {
            background: var(--accent-color-darker, #005a99);
            transform: translateY(-1px);
        }
        
        /* 검색 결과 제목 */
        .search-result--title {
            display: none;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--card-text-color-main, #1a1a1a);
            margin-bottom: 1.5rem;
        }
        
        .search-result--title.show {
            display: block;
        }
        
        /* 다크모드에서 검색 결과 제목 */
        @media (prefers-color-scheme: dark) {
            .search-result--title {
                color: var(--card-text-color-main, #ffffff);
            }
        }
        
        [data-scheme="dark"] .search-result--title,
        .dark .search-result--title,
        body.dark .search-result--title {
            color: var(--card-text-color-main, #ffffff) !important;
        }
    </style>
{{ end }}

{{ define "main" }}
<form class="search-form" onsubmit="return false;">
    <p>
        <label>{{ T "search.title" }}</label>
        <input id="pagefind-search-input" name="keyword" placeholder="{{ T `search.placeholder` }}" />
    </p>
    <button type="button" title="{{ T `search.title` }}" onclick="performSearch()">
        {{ partial "helper/icon" "search" }}
    </button>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list">
        <!-- Pagefind UI가 여기에 삽입됨 (숨겨짐) -->
        <div id="pagefind-search" style="display: none;"></div>
        <!-- 커스텀 검색 결과가 여기에 표시됨 -->
        <div id="custom-search-results" class="search-results-container"></div>
    </div>
</div>

<script>
/**
 * 간소화된 Pagefind 검색 페이지
 * - 레이아웃 시프트 완전 방지
 * - 고정된 이미지 영역
 * - 간단하고 명확한 코드 구조
 */

// ========================================
// 전역 변수
// ========================================
let pagefindInstance;
const imageCache = new Map();

// 성능 최적화용 변수들
let convertPagefindResultsTimeout = null;
let lastProcessedResultsCount = 0;
let isConverting = false;
const processedUrls = new Set();

// ========================================
// 유틸리티 함수
// ========================================

/**
 * Debounce 함수 - 연속적인 호출을 방지
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * 다크모드 감지
 */
function isDarkMode() {
    return document.documentElement.getAttribute('data-scheme') === 'dark' || 
                      document.documentElement.classList.contains('dark') || 
                      document.body.classList.contains('dark') ||
                      window.matchMedia('(prefers-color-scheme: dark)').matches;
}

/**
 * 이미지 URL 생성
 */
function generateImageCandidates(pageUrl) {
        const url = new URL(pageUrl, window.location.origin);
        const basePath = url.pathname.endsWith('/') ? url.pathname.slice(0, -1) : url.pathname;
    
    return [
        `${basePath}/poster.webp`,
        `${basePath}/poster.jpg`,
        `${basePath}/poster.png`,
        `${basePath}/image.webp`,
        `${basePath}/image.jpg`,
        `${basePath}/image.png`
    ];
}

/**
 * Pagefind 메타데이터에서 이미지 URL 추출
 */
function extractImageFromPagefindMeta(result) {
    console.log('🔍 extractImageFromPagefindMeta 호출됨:', result);
    
    // Pagefind 결과의 메타데이터에서 이미지 정보 확인
    if (result.meta && result.meta.image) {
        let imageUrl = result.meta.image.trim();
        console.log('📸 원본 이미지 URL:', imageUrl);
        
        // 빈 문자열이 아닌지 확인
        if (!imageUrl) {
            console.log('❌ 빈 이미지 URL');
            return null;
        }
        
        // 상대 경로인 경우 절대 경로로 변환
        if (imageUrl.startsWith('/')) {
            imageUrl = window.location.origin + imageUrl;
            console.log('🔄 상대 경로를 절대 경로로 변환:', imageUrl);
        } else if (!imageUrl.startsWith('http')) {
            // 프로토콜이 없는 경우 상대 경로로 간주
            imageUrl = window.location.origin + '/' + imageUrl.replace(/^\/+/, '');
            console.log('🔄 프로토콜 없는 경로를 절대 경로로 변환:', imageUrl);
        }
        
        console.log('✅ 최종 이미지 URL:', imageUrl);
        return imageUrl;
    }
    
    console.log('❌ 이미지 메타데이터 없음');
    return null;
}

/**
 * 이미지 존재 확인
 */
async function checkImageExists(imageUrl) {
    console.log('🔍 checkImageExists 호출됨:', imageUrl);
    try {
        const response = await fetch(imageUrl, { method: 'HEAD' });
        const exists = response.ok;
        console.log('🔍 이미지 존재 확인 결과:', exists, '상태 코드:', response.status);
        return exists;
    } catch (error) {
        console.log('❌ 이미지 존재 확인 실패:', error);
        return false;
    }
}

/**
 * 페이지에서 이미지 찾기
 */
async function findImageInPage(pageUrl) {
    // 캐시 확인
    if (imageCache.has(pageUrl)) {
        return imageCache.get(pageUrl);
    }
    
    try {
        // 1. 기본 후보 이미지 확인
        // const candidates = generateImageCandidates(pageUrl);
        // for (const candidate of candidates) {
        //     if (await checkImageExists(candidate)) {
        //         imageCache.set(pageUrl, candidate);
        //         return candidate;
        //     }
        // }
        
        // 2. 페이지 파싱해서 이미지 찾기
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(pageUrl, { 
            signal: controller.signal,
            cache: 'force-cache'
        });
        clearTimeout(timeoutId);
        
        if (response.ok) {
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
            // article 내 첫 번째 이미지 찾기
            const articleImg = doc.querySelector('article img, .article-content img, .content img, main img');
            if (articleImg) {
            let src = articleImg.src || articleImg.getAttribute('src') || articleImg.getAttribute('data-src');
                if (src && !src.includes('avatar') && !src.includes('favicon')) {
            if (src.startsWith('/')) {
                src = window.location.origin + src;
            }
                    imageCache.set(pageUrl, src);
            return src;
                }
            }
        }
        
        // 이미지를 찾을 수 없음
        imageCache.set(pageUrl, null);
        return null;
    } catch (error) {
            console.warn('이미지 검색 실패:', pageUrl, error.message);
        imageCache.set(pageUrl, null);
        return null;
    }
}

// ========================================
// 검색 결과 렌더링
// ========================================

/**
 * 커스텀 검색 결과 생성
 */
function createCustomSearchResult(result) {
    const resultElement = document.createElement('div');
    resultElement.className = 'search-result-item';
    
    // 이미지 영역 (고정 크기)
    const imageDiv = document.createElement('div');
    imageDiv.className = 'search-result-image loading';
    imageDiv.href = result.url;
    imageDiv.innerHTML = '<div>이미지 로딩 중...</div>';
    
    // 컨텐츠 영역
    const contentDiv = document.createElement('div');
    contentDiv.className = 'search-result-content';
    
    // 제목
    const titleLink = document.createElement('a');
    titleLink.className = 'search-result-title';
    titleLink.href = result.url;
    titleLink.textContent = result.meta?.title || '제목 없음';
    
    // 요약
    const excerptDiv = document.createElement('div');
    excerptDiv.className = 'search-result-excerpt';
    excerptDiv.innerHTML = result.excerpt || '';
    
    // 메타 정보
    const metaDiv = document.createElement('div');
    metaDiv.className = 'search-result-meta';
    metaDiv.textContent = new URL(result.url).pathname;
    
    // DOM 요소들을 올바른 순서로 추가
    contentDiv.appendChild(titleLink);  // 1. 제목 먼저
    contentDiv.appendChild(excerptDiv); // 2. 요약
    
    // 소제목들 (sub-results) 처리
    if (result.sub_results && result.sub_results.length > 0) {
        result.sub_results.forEach(subResult => {
            const subDiv = document.createElement('div');
            subDiv.className = 'search-result-sub';
            
            const subTitleLink = document.createElement('a');
            subTitleLink.className = 'search-result-sub-title';
            subTitleLink.href = subResult.url;
            subTitleLink.textContent = subResult.title || '소제목';
            
            const subExcerptDiv = document.createElement('div');
            subExcerptDiv.className = 'search-result-sub-excerpt';
            subExcerptDiv.innerHTML = subResult.excerpt || '';
            
            subDiv.appendChild(subTitleLink);
            if (subResult.excerpt) {
                subDiv.appendChild(subExcerptDiv);
            }
            
            contentDiv.appendChild(subDiv);  // 3. 소제목들
        });
    }
    
    // 태그들 처리
    if (result.meta?.tags && result.meta.tags.length > 0) {
        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'search-result-tags';
        
        result.meta.tags.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'search-result-tag';
            tagSpan.textContent = tag;
            tagsDiv.appendChild(tagSpan);
        });
        
        contentDiv.appendChild(tagsDiv);  // 4. 태그들
    }
    
    contentDiv.appendChild(metaDiv);    // 5. 마지막에 메타 정보
    
    resultElement.appendChild(imageDiv);
    resultElement.appendChild(contentDiv);
    
    // 이미지 로딩 시작 (Pagefind 메타데이터 우선 사용)
    console.log('🖼️ loadImageForResult 호출 준비:', {
        resultUrl: result.url,
        metaImage: result.meta?.image,
        imageDiv: !!imageDiv
    });
    loadImageForResult(imageDiv, result.url, result.meta?.image);
    
    return resultElement;
}

/**
 * 결과에 이미지 로딩
 */
async function loadImageForResult(imageDiv, pageUrl, metaImage) {
    console.log('🖼️ loadImageForResult 호출됨:', { pageUrl, metaImage });
    
    try {
        let imageUrl = null;
        
        // 1. Pagefind 메타데이터 이미지 우선 확인
        if (metaImage) {
            console.log('📸 메타데이터 이미지 사용:', metaImage);
            // 이미 절대 경로인지 확인
            imageUrl = metaImage.startsWith('http') ? metaImage : 
                      metaImage.startsWith('/') ? window.location.origin + metaImage : metaImage;
            
            console.log('🔗 변환된 이미지 URL:', imageUrl);
            
            if (await checkImageExists(imageUrl)) {
                console.log('✅ 메타데이터 이미지 존재 확인됨');
                loadImageSuccess(imageDiv, imageUrl);
                return;
            } else {
                console.log('❌ 메타데이터 이미지 존재하지 않음');
            }
        } else {
            console.log('❌ 메타데이터 이미지 없음');
        }
        
        // 2. 페이지에서 이미지 찾기 (fallback)
        // imageUrl = await findImageInPage(pageUrl);
        
        if (imageUrl) {
            loadImageSuccess(imageDiv, imageUrl);
        } else {
            console.log('❌ 이미지 URL 없음, 실패 처리');
            loadImageFailed(imageDiv);
        }
    } catch (error) {
        console.warn('이미지 로딩 실패:', pageUrl, error);
        loadImageFailed(imageDiv);
    }
}

/**
 * 이미지 로딩 성공
 */
function loadImageSuccess(imageDiv, imageUrl) {
    console.log('✅ loadImageSuccess 호출됨:', imageUrl);
    console.log('🖼️ imageDiv 요소:', imageDiv);
    console.log('🖼️ imageDiv 현재 클래스:', imageDiv.className);
    console.log('🖼️ imageDiv 현재 HTML:', imageDiv.innerHTML);
    
    imageDiv.className = 'search-result-image';
    
    const img = document.createElement('img');
    img.alt = '검색 결과 이미지';
    // lazy loading 제거 - 즉시 로딩
    // img.loading = 'lazy';
    
    console.log('🖼️ 생성된 img 요소:', img);
    
    // 이미지 로딩 타임아웃 설정 (10초로 연장)
    const timeoutId = setTimeout(() => {
        console.log('⏰ 이미지 로딩 타임아웃:', imageUrl);
        loadImageFailed(imageDiv);
    }, 10000);
    
    // onload/onerror 이벤트 먼저 설정
    img.onload = () => {
        console.log('🖼️ 이미지 로드 성공:', imageUrl);
        console.log('🖼️ DOM 업데이트 시작');
        clearTimeout(timeoutId); // 타임아웃 해제
        imageDiv.innerHTML = '';
        imageDiv.appendChild(img);
        console.log('🖼️ 이미지 요소가 DOM에 추가됨');
        console.log('🖼️ imageDiv 최종 HTML:', imageDiv.innerHTML);
    };
    
    img.onerror = () => {
        console.log('❌ 이미지 로드 실패:', imageUrl);
        clearTimeout(timeoutId); // 타임아웃 해제
        loadImageFailed(imageDiv);
    };
    
    // 마지막에 src 설정 (이벤트 설정 후)
    console.log('🖼️ img.src 설정 시작:', imageUrl);
    img.src = imageUrl;
    console.log('🖼️ img.src 설정 완료:', img.src);
    
    // src 설정 후 즉시 캐시된 이미지인지 확인
    setTimeout(() => {
        if (img.complete) {
            console.log('🖼️ 이미지가 즉시 로딩됨 (캐시됨), 처리 중');
            clearTimeout(timeoutId);
            if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                console.log('🖼️ 캐시된 이미지 로드 성공:', img.naturalWidth, 'x', img.naturalHeight);
                imageDiv.innerHTML = '';
                imageDiv.appendChild(img);
                console.log('🖼️ 캐시된 이미지 DOM에 추가 완료');
            } else {
                console.log('❌ 캐시된 이미지 크기 정보 없음, 일반 로딩 계속');
                // 캐시된 이미지에 문제가 있으면 강제로 다시 로딩
                const newSrc = img.src + '?t=' + Date.now();
                console.log('🔄 이미지 강제 재로딩 시도:', newSrc);
                img.src = newSrc;
            }
        } else {
            console.log('🖼️ 이미지 로딩 중, 이벤트 대기');
        }
    }, 10);
}

/**
 * 이미지 로딩 실패
 */
function loadImageFailed(imageDiv) {
    console.log('❌ loadImageFailed 호출됨');
    console.log('🖼️ imageDiv 요소:', imageDiv);
    console.log('🖼️ imageDiv 변경 전 클래스:', imageDiv.className);
    console.log('🖼️ imageDiv 변경 전 HTML:', imageDiv.innerHTML);
    
    imageDiv.className = 'search-result-image no-image';
    imageDiv.innerHTML = '<div>이미지 없음</div>';
    
    console.log('🖼️ imageDiv 최종 클래스:', imageDiv.className);
    console.log('🖼️ imageDiv 최종 HTML:', imageDiv.innerHTML);
}

// ========================================
// 검색 기능
// ========================================

// 중복 검색 방지를 위한 변수
let currentSearchTerm = '';
let isSearching = false;

/**
 * 검색 실행
 */
function performSearch() {
    const searchTerm = document.getElementById('pagefind-search-input').value.trim();
    
    if (!searchTerm) {
        hideSearchResults();
        return;
    }
    
    // 동일한 검색어로 이미 검색 중인 경우 중복 실행 방지
    if (isSearching && currentSearchTerm === searchTerm) {
        console.log('동일한 검색어로 이미 검색 중, 건너뜀:', searchTerm);
        return;
    }
    
    // 동일한 검색어인데 이미 결과가 있는 경우 스킵
    const customResultsContainer = document.getElementById('custom-search-results');
    if (currentSearchTerm === searchTerm && customResultsContainer.children.length > 0) {
        console.log('동일한 검색어의 결과가 이미 표시됨, 건너뜀:', searchTerm);
        return;
    }
    
    // 검색 시작
    isSearching = true;
    
    // 새로운 검색어인 경우에만 상태 초기화
    if (currentSearchTerm !== searchTerm) {
        console.log('새로운 검색어 감지, 상태 초기화:', currentSearchTerm, '->', searchTerm);
        currentSearchTerm = searchTerm;
        processedUrls.clear();
        lastProcessedResultsCount = 0;
        isConverting = false;
        
        // 기존 결과 컨테이너 초기화 (새로운 검색어인 경우에만)
        customResultsContainer.innerHTML = '';
    } else {
        console.log('동일한 검색어 재실행, 초기화 생략:', searchTerm);
    }
    
    console.log(`새 검색 시작: "${searchTerm}"`);
        
    // 검색 결과 제목 업데이트
    updateSearchResultTitle(searchTerm);
    
    // Pagefind 검색 실행
    const pagefindInput = document.querySelector('.pagefind-ui__search-input');
    if (pagefindInput) {
        pagefindInput.value = searchTerm;
        pagefindInput.dispatchEvent(new Event('input'));
    }
    
    // 검색 완료 표시 (약간의 지연 후)
    setTimeout(() => {
        isSearching = false;
    }, 1000);
}

/**
 * 검색 결과 제목 업데이트
 */
function updateSearchResultTitle(searchTerm) {
        const resultTitle = document.querySelector('.search-result--title');
    if (searchTerm) {
            resultTitle.textContent = `"${searchTerm}"에 대한 검색 결과`;
        resultTitle.classList.add('show');
        } else {
        resultTitle.classList.remove('show');
    }
}

/**
 * 검색 결과 숨기기
 */
function hideSearchResults() {
    const resultTitle = document.querySelector('.search-result--title');
    resultTitle.classList.remove('show');
    const customResultsContainer = document.getElementById('custom-search-results');
    customResultsContainer.innerHTML = '';
    
    // 상태 초기화
    processedUrls.clear();
    lastProcessedResultsCount = 0;
    isConverting = false;
}

// ========================================
// 초기화
// ========================================


// debounced 버전의 convertPagefindResults 생성
const debouncedConvertResults = debounce(convertPagefindResults, 300);

document.addEventListener('DOMContentLoaded', function() {
    const customResultsContainer = document.getElementById('custom-search-results');
    
    // PagefindUI 초기화
    pagefindInstance = new PagefindUI({ 
        element: "#pagefind-search",
        showSubResults: true,
        showEmptyFilters: true,
        resetStyles: false,
        autofocus: false,
        processResult: function(result) {
            // 작성자 정보 정리
            if (result.meta?.author === "42jerrykim") {
                delete result.meta.author;
            }
            
            // 제목 정리
            if (result.meta?.title) {
                result.meta.title = result.meta.title.trim();
            }
            
            // 이미지 메타데이터 처리
            if (result.meta?.image) {
                // 상대 경로인 경우 절대 경로로 변환
                if (result.meta.image.startsWith('/')) {
                    result.meta.image = window.location.origin + result.meta.image;
                }
            }
            
            return result;
        },
        translations: {
            placeholder: "검색어를 입력하세요...",
            clear_search: "검색 지우기",
            load_more: "더 보기",
            search_label: "사이트 검색",
            filters_label: "필터",
            zero_results: "검색 결과가 없습니다: [SEARCH_TERM]",
            many_results: "[COUNT]개의 결과가 있습니다: [SEARCH_TERM]",
            one_result: "1개의 결과가 있습니다: [SEARCH_TERM]",
            alt_search: "검색: [SEARCH_TERM]",
            search_suggestion: "검색어를 입력하세요",
            searching: "검색 중..."
        }
    });
    
    // 개선된 Pagefind 결과 감지 및 커스텀 결과로 변환
    const observer = new MutationObserver(function(mutations) {
        let shouldUpdate = false;
        
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                // Pagefind 결과나 메시지가 추가되었는지 확인
                const addedNodes = Array.from(mutation.addedNodes);
                const hasRelevantChanges = addedNodes.some(node => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        return node.classList.contains('pagefind-ui__result') ||
                               node.classList.contains('pagefind-ui__message') ||
                               node.classList.contains('pagefind-ui__button') ||
                               node.querySelector('.pagefind-ui__result') ||
                               node.querySelector('.pagefind-ui__message') ||
                               node.querySelector('.pagefind-ui__button');
                    }
                    return false;
                });
                
                if (hasRelevantChanges) {
                    shouldUpdate = true;
                }
            }
        });
        
        if (shouldUpdate) {
            console.log("관련 변경사항 감지 - Pagefind 결과 업데이트");
            debouncedConvertResults();
        }
    });
    
    // Pagefind 컨테이너 관찰
    const pagefindContainer = document.getElementById('pagefind-search');
    if (pagefindContainer) {
        observer.observe(pagefindContainer, { childList: true, subtree: true });
    }
    
    // 커스텀 검색 입력과 PagefindUI 연결
    const customInput = document.getElementById('pagefind-search-input');
    customInput.addEventListener('input', performSearch);
    customInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // URL 파라미터에서 검색어 추출
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('keyword') || urlParams.get('q') || urlParams.get('search');
    
    if (searchQuery) {
        customInput.value = searchQuery;
        setTimeout(performSearch, 500);
    }
});

/**
 * Pagefind 결과를 커스텀 결과로 변환 (최적화된 버전)
 */
async function convertPagefindResults() {
    // 중복 실행 방지
    if (isConverting) {
        console.log('convertPagefindResults 이미 실행 중, 건너뜀');
        return;
    }
    
    isConverting = true;
    
    try {
        const customResultsContainer = document.getElementById('custom-search-results');
        console.log('convertPagefindResults 실행 시작');
        
        // Pagefind 결과 가져오기
        const pagefindResults = document.querySelectorAll('#pagefind-search .pagefind-ui__result');
        
        // 결과 개수가 이전과 같으면 스킵 (추가 최적화)
        if (pagefindResults.length === lastProcessedResultsCount && pagefindResults.length > 0) {
            console.log('결과 개수 동일, 변환 건너뜀');
            isConverting = false;
            return;
        }
        
        if (pagefindResults.length === 0) {
            // 메시지 처리 (검색 결과 없음 등)
            const message = document.querySelector('#pagefind-search .pagefind-ui__message');
            if (message) {
                customResultsContainer.innerHTML = '';
                const customMessage = message.cloneNode(true);
                customResultsContainer.appendChild(customMessage);
            }
            lastProcessedResultsCount = 0;
            processedUrls.clear();
            isConverting = false;
            return;
        }
        
        console.log(`Pagefind 결과 ${pagefindResults.length}개 처리 시작`);
        
        // 새로운 검색인 경우 컨테이너 초기화 (이미 performSearch에서 처리되었지만 추가 보장)
        if (pagefindResults.length > 0 && customResultsContainer.children.length === 0) {
            customResultsContainer.innerHTML = '';
        }
        
        // 새로운 결과만 추가하는 방식으로 최적화
        let addedCount = 0;
        
        // 각 결과를 커스텀 형식으로 변환
        for (const pagefindResult of pagefindResults) {
            try {
                // Pagefind 결과에서 데이터 추출
                const titleElement = pagefindResult.querySelector('.pagefind-ui__result-link');
                const excerptElement = pagefindResult.querySelector('.pagefind-ui__result-excerpt');
                const subResultElements = pagefindResult.querySelectorAll('.pagefind-ui__result-nested');
                const tagElements = pagefindResult.querySelectorAll('.pagefind-ui__result-tag');
                
                if (!titleElement) continue;
                
                const resultUrl = titleElement.href;
                
                // 이미 처리된 URL인지 확인 (중복 방지) - 새 검색의 경우는 skip
                if (processedUrls.has(resultUrl)) {
                    console.log('중복 URL 스킵:', resultUrl);
                    continue;
                }
                
                console.log('새 결과 처리:', resultUrl);
                
                // 소제목들 추출
                const subResults = [];
                subResultElements.forEach(subElement => {
                    const subTitleEl = subElement.querySelector('.pagefind-ui__result-link');
                    const subExcerptEl = subElement.querySelector('.pagefind-ui__result-excerpt');
                    
                    if (subTitleEl) {
                        subResults.push({
                            title: subTitleEl.textContent.trim(),
                            url: subTitleEl.href,
                            excerpt: subExcerptEl ? subExcerptEl.innerHTML : ''
                        });
                    }
                });
                
                // 태그들 추출
                const tags = [];
                tagElements.forEach(tagEl => {
                    const tagText = tagEl.textContent.trim();
                    if (tagText) {
                        tags.push(tagText);
                    }
                });
                
                // Pagefind 결과에서 이미지 정보 추출 (여러 방법 시도)
                let pagefindImage = null;
                
                // 방법 1: Pagefind가 렌더링한 <img> 태그에서 직접 추출
                const pagefindImgElement = pagefindResult.querySelector('img.pagefind-ui__result-image');
                if (pagefindImgElement && pagefindImgElement.src) {
                    pagefindImage = pagefindImgElement.src;
                    console.log('📸 방법 1 - <img> 태그에서 추출된 이미지 URL:', pagefindImage);
                }
                
                // 방법 2: data-pagefind-meta="image" 요소에서 추출 (fallback)
                if (!pagefindImage) {
                    const imageMetaElement = pagefindResult.querySelector('[data-pagefind-meta="image"]');
                    if (imageMetaElement) {
                        const imageText = imageMetaElement.textContent.trim();
                        if (imageText) {
                            pagefindImage = extractImageFromPagefindMeta({
                                meta: { image: imageText }
                            });
                            console.log('📸 방법 2 - data-pagefind-meta에서 추출된 이미지 URL:', pagefindImage);
                        }
                    }
                }
                
                // 방법 3: pagefind-image-hidden 클래스에서 추출 (fallback)
                if (!pagefindImage) {
                    const hiddenImageElement = pagefindResult.querySelector('.pagefind-image-hidden');
                    if (hiddenImageElement) {
                        const imageText = hiddenImageElement.textContent.trim();
                        if (imageText) {
                            pagefindImage = extractImageFromPagefindMeta({
                                meta: { image: imageText }
                            });
                            console.log('📸 방법 3 - pagefind-image-hidden에서 추출된 이미지 URL:', pagefindImage);
                        }
                    }
                }
                
                // 방법 4: 모든 data-pagefind-meta 속성을 가진 요소 확인 (fallback)
                if (!pagefindImage) {
                    const allMetaElements = pagefindResult.querySelectorAll('[data-pagefind-meta]');
                    allMetaElements.forEach(el => {
                        const key = el.getAttribute('data-pagefind-meta');
                        if (key === 'image' && !pagefindImage) {
                            const imageText = el.textContent.trim();
                            if (imageText) {
                                pagefindImage = extractImageFromPagefindMeta({
                                    meta: { image: imageText }
                                });
                                console.log('📸 방법 4 - 메타데이터에서 추출된 이미지 URL:', pagefindImage);
                            }
                        }
                    });
                }
                
                const result = {
                    url: resultUrl,
                    meta: {
                        title: titleElement.textContent.trim(),
                        tags: tags.length > 0 ? tags : undefined,
                        image: pagefindImage
                    },
                    excerpt: excerptElement ? excerptElement.innerHTML : '',
                    sub_results: subResults.length > 0 ? subResults : undefined
                };
                
                // 커스텀 결과 생성 및 추가
                console.log('createCustomSearchResult 호출 시작:', resultUrl);
                const customResult = createCustomSearchResult(result);
                console.log('createCustomSearchResult 완료:', !!customResult, customResult ? customResult.className : 'no element');
                
                if (customResult) {
                    console.log('DOM에 추가 시작');
                    customResultsContainer.appendChild(customResult);
                    console.log('DOM에 추가 완료, 현재 children count:', customResultsContainer.children.length);
                } else {
                    console.error('createCustomSearchResult가 null 반환');
                }
                
                // 처리된 URL 기록
                processedUrls.add(resultUrl);
                addedCount++;
                
            } catch (error) {
                console.warn('결과 변환 실패:', error);
            }
        }
        
        console.log(`새로운 결과 ${addedCount}개 추가됨`);
        
        // "더 보기" 버튼 처리 (기존 버튼 제거 후 새로 추가)
        const existingLoadMoreButton = customResultsContainer.querySelector('.pagefind-ui__button');
        if (existingLoadMoreButton) {
            existingLoadMoreButton.remove();
        }
        
        const loadMoreButton = document.querySelector('#pagefind-search .pagefind-ui__button');
        if (loadMoreButton) {
            const customLoadMoreButton = loadMoreButton.cloneNode(true);
            customLoadMoreButton.onclick = () => {
                loadMoreButton.click();
                console.log("더 보기 버튼 클릭");
                // debounce를 적용한 호출
                debouncedConvertResults();
            };
            customResultsContainer.appendChild(customLoadMoreButton);
        }
        
        lastProcessedResultsCount = pagefindResults.length;
        
    } catch (error) {
        console.error('convertPagefindResults 실행 실패:', error);
    } finally {
        isConverting = false;
    }
}

// 전역 접근을 위한 별칭
window.performSearch = performSearch;
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1523508823345999"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-1523508823345999"
     data-ad-slot="2764508212"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
{{ partialCached "footer/footer" . }}
{{ end }}
