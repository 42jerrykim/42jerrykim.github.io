---
draft: true
---
# 4ì¥. ëª¨ë˜ ì•„í‚¤í…ì²˜ íŒ¨ëŸ¬ë‹¤ì„

## ğŸ“‹ í•™ìŠµ ëª©í‘œ
- ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ ê°œë…ê³¼ êµ¬í˜„ ë°©ë²•ì„ ì´í•´í•œë‹¤
- ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜ì˜ íŠ¹ì§•ê³¼ ì ìš© ì‹œë‚˜ë¦¬ì˜¤ë¥¼ íŒŒì•…í•œë‹¤
- í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ì˜ ì„¤ê³„ ì›ì¹™ê³¼ êµ¬í˜„ ê¸°ë²•ì„ ìŠµë“í•œë‹¤
- CQRSì™€ ì´ë²¤íŠ¸ ì†Œì‹±ì˜ ê°œë…ê³¼ ì‹¤ë¬´ ì ìš© ë°©ë²•ì„ í•™ìŠµí•œë‹¤

---

## 4.1 ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜

### 4.1.1 ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë€?

ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ëŠ” í•˜ë‚˜ì˜ í° ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì—¬ëŸ¬ ê°œì˜ ì‘ê³  ë…ë¦½ì ì¸ ì„œë¹„ìŠ¤ë¡œ ë¶„í•´í•˜ëŠ” ì ‘ê·¼ ë°©ì‹ì…ë‹ˆë‹¤.

#### í•µì‹¬ íŠ¹ì§•
- **ì„œë¹„ìŠ¤ ììœ¨ì„±**: ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ìœ¼ë¡œ ê°œë°œ, ë°°í¬, í™•ì¥ ê°€ëŠ¥
- **ë¹„ì¦ˆë‹ˆìŠ¤ ì¤‘ì‹¬ ë¶„í•´**: ë„ë©”ì¸ ê¸°ë°˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê²½ê³„ ì„¤ì •
- **ë¶„ì‚° ë°ì´í„° ê´€ë¦¬**: ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì ì¸ ë°ì´í„°ë² ì´ìŠ¤
- **API ê¸°ë°˜ í†µì‹ **: REST API, GraphQL, gRPC ë“±ì„ í†µí•œ í†µì‹ 

### 4.1.2 ëª¨ë†€ë¦¬ìŠ¤ vs ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤

| **ì¸¡ë©´** | **ëª¨ë†€ë¦¬ìŠ¤** | **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤** |
|---------|-------------|------------------|
| **ë°°í¬** | ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¨ìœ„ | ì„œë¹„ìŠ¤ë³„ ë…ë¦½ ë°°í¬ |
| **í™•ì¥ì„±** | ìˆ˜ì§ í™•ì¥ ì¤‘ì‹¬ | ì„œë¹„ìŠ¤ë³„ ìˆ˜í‰ í™•ì¥ |
| **ê¸°ìˆ  ìŠ¤íƒ** | ë‹¨ì¼ ê¸°ìˆ  ìŠ¤íƒ | ì„œë¹„ìŠ¤ë³„ ìµœì  ê¸°ìˆ  ì„ íƒ |
| **ì¥ì•  ì˜í–¥ë„** | ì „ì²´ ì‹œìŠ¤í…œ ì¤‘ë‹¨ | íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ì˜í–¥ |
| **íŒ€ êµ¬ì¡°** | ê¸°ëŠ¥ë³„ íŒ€ | ì„œë¹„ìŠ¤ë³„ ì „ë‹´ íŒ€ |

### 4.1.3 ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ êµ¬í˜„ ì˜ˆì œ

#### ì£¼ë¬¸ ì„œë¹„ìŠ¤ ì˜ˆì œ

```java
// OrderController.java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping
    public ResponseEntity<OrderResponse> createOrder(@RequestBody CreateOrderRequest request) {
        try {
            Order order = orderService.createOrder(request);
            return ResponseEntity.ok(new OrderResponse(order));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new OrderResponse("ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨: " + e.getMessage()));
        }
    }
    
    @GetMapping("/{orderId}")
    public ResponseEntity<OrderResponse> getOrder(@PathVariable String orderId) {
        Optional<Order> order = orderService.findById(orderId);
        return order.map(o -> ResponseEntity.ok(new OrderResponse(o)))
                   .orElse(ResponseEntity.notFound().build());
    }
}

// OrderService.java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    public Order createOrder(CreateOrderRequest request) {
        // 1. ì¬ê³  í™•ì¸
        if (!inventoryServiceClient.checkAvailability(request.getProductId(), request.getQuantity())) {
            throw new RuntimeException("ì¬ê³  ë¶€ì¡±");
        }
        
        // 2. ì£¼ë¬¸ ìƒì„±
        Order order = new Order(
            UUID.randomUUID().toString(),
            request.getCustomerId(),
            request.getProductId(),
            request.getQuantity(),
            request.getPrice(),
            OrderStatus.PENDING
        );
        
        orderRepository.save(order);
        
        // 3. ê²°ì œ ì²˜ë¦¬ (ë¹„ë™ê¸°)
        CompletableFuture.runAsync(() -> {
            try {
                PaymentResult result = paymentServiceClient.processPayment(
                    order.getId(), order.getTotalAmount()
                );
                
                if (result.isSuccess()) {
                    updateOrderStatus(order.getId(), OrderStatus.CONFIRMED);
                } else {
                    updateOrderStatus(order.getId(), OrderStatus.FAILED);
                }
            } catch (Exception e) {
                updateOrderStatus(order.getId(), OrderStatus.FAILED);
            }
        });
        
        return order;
    }
    
    private void updateOrderStatus(String orderId, OrderStatus status) {
        orderRepository.findById(orderId).ifPresent(order -> {
            order.setStatus(status);
            orderRepository.save(order);
            
            // ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ ë°œí–‰
            eventPublisher.publishEvent(new OrderStatusChangedEvent(orderId, status));
        });
    }
}
```

#### ì„œë¹„ìŠ¤ ê°„ í†µì‹  - Feign Client

```java
// PaymentServiceClient.java
@FeignClient(name = "payment-service", url = "${payment.service.url}")
public interface PaymentServiceClient {
    
    @PostMapping("/api/payments")
    PaymentResult processPayment(@RequestBody PaymentRequest request);
    
    @GetMapping("/api/payments/{paymentId}")
    PaymentStatus getPaymentStatus(@PathVariable String paymentId);
}

// Circuit Breaker ì ìš©
@Component
public class PaymentServiceClientImpl {
    
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    
    @CircuitBreaker(name = "payment-service", fallbackMethod = "fallbackPayment")
    public PaymentResult processPayment(String orderId, BigDecimal amount) {
        return paymentServiceClient.processPayment(
            new PaymentRequest(orderId, amount)
        );
    }
    
    public PaymentResult fallbackPayment(String orderId, BigDecimal amount, Exception ex) {
        // ì¥ì•  ìƒí™©ì—ì„œì˜ ëŒ€ì•ˆ ì²˜ë¦¬
        return PaymentResult.failed("ê²°ì œ ì„œë¹„ìŠ¤ ì¼ì‹œ ì¤‘ë‹¨");
    }
}
```

### 4.1.4 ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì˜ ì¥ì ê³¼ ë‹¨ì 

#### ì¥ì 
- **ë…ë¦½ì  ë°°í¬**: ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì ì¸ ë¦´ë¦¬ì¦ˆ ì‚¬ì´í´
- **ê¸°ìˆ  ë‹¤ì–‘ì„±**: ì„œë¹„ìŠ¤ë³„ ìµœì  ê¸°ìˆ  ìŠ¤íƒ ì„ íƒ ê°€ëŠ¥
- **í™•ì¥ì„±**: íŠ¸ë˜í”½ì— ë”°ë¥¸ ì„œë¹„ìŠ¤ë³„ í™•ì¥
- **ì¥ì•  ê²©ë¦¬**: ë¶€ë¶„ ì¥ì• ê°€ ì „ì²´ ì‹œìŠ¤í…œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ìµœì†Œí™”

#### ë‹¨ì 
- **ë³µì¡ì„± ì¦ê°€**: ë¶„ì‚° ì‹œìŠ¤í…œì˜ ë³µì¡ì„±
- **ë„¤íŠ¸ì›Œí¬ í†µì‹ **: ì„œë¹„ìŠ¤ ê°„ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ê³¼ ì‹¤íŒ¨ ê°€ëŠ¥ì„±
- **ë°ì´í„° ì¼ê´€ì„±**: ë¶„ì‚° íŠ¸ëœì­ì…˜ ê´€ë¦¬ì˜ ì–´ë ¤ì›€
- **ìš´ì˜ ë³µì¡ì„±**: ì—¬ëŸ¬ ì„œë¹„ìŠ¤ì˜ ëª¨ë‹ˆí„°ë§ê³¼ ë””ë²„ê¹…

---

## 4.2 ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜

### 4.2.1 ì„œë²„ë¦¬ìŠ¤ë€?

ì„œë²„ë¦¬ìŠ¤(Serverless)ëŠ” ê°œë°œìê°€ ì„œë²„ ê´€ë¦¬ì— ì‹ ê²½ ì“°ì§€ ì•Šê³  ì½”ë“œ ì‹¤í–‰ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆëŠ” í´ë¼ìš°ë“œ ì»´í“¨íŒ… ëª¨ë¸ì…ë‹ˆë‹¤.

#### í•µì‹¬ íŠ¹ì§•
- **Function as a Service (FaaS)**: í•¨ìˆ˜ ë‹¨ìœ„ì˜ ì‹¤í–‰ í™˜ê²½
- **ì´ë²¤íŠ¸ ê¸°ë°˜**: ì´ë²¤íŠ¸ ë°œìƒ ì‹œì—ë§Œ ì‹¤í–‰
- **ìë™ ìŠ¤ì¼€ì¼ë§**: ìš”ì²­ëŸ‰ì— ë”°ë¥¸ ìë™ í™•ì¥/ì¶•ì†Œ
- **ì¢…ëŸ‰ì œ ê³¼ê¸ˆ**: ì‹¤í–‰ ì‹œê°„ê³¼ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì— ë”°ë¥¸ ê³¼ê¸ˆ

### 4.2.2 ì„œë²„ë¦¬ìŠ¤ vs ì „í†µì  ì„œë²„

| **ì¸¡ë©´** | **ì „í†µì  ì„œë²„** | **ì„œë²„ë¦¬ìŠ¤** |
|---------|---------------|-------------|
| **ì„œë²„ ê´€ë¦¬** | ì§ì ‘ ê´€ë¦¬ í•„ìš” | í´ë¼ìš°ë“œ ì œê³µìê°€ ê´€ë¦¬ |
| **í™•ì¥ì„±** | ìˆ˜ë™ ìŠ¤ì¼€ì¼ë§ | ìë™ ìŠ¤ì¼€ì¼ë§ |
| **ë¹„ìš©** | ê³ ì • ë¹„ìš© | ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ë¹„ìš© |
| **ê°œë°œ ì§‘ì¤‘ë„** | ì¸í”„ë¼ + ì½”ë“œ | ì½”ë“œì—ë§Œ ì§‘ì¤‘ |
| **ì½œë“œ ìŠ¤íƒ€íŠ¸** | ì—†ìŒ | ì´ˆê¸° ì§€ì—° ë°œìƒ ê°€ëŠ¥ |

### 4.2.3 ì„œë²„ë¦¬ìŠ¤ êµ¬í˜„ ì˜ˆì œ

#### AWS Lambda í•¨ìˆ˜ ì˜ˆì œ

```java
// OrderProcessor.java
public class OrderProcessor implements RequestHandler<OrderEvent, OrderResult> {
    
    private final DynamoDB dynamoDB = DynamoDBBuilder.standard().build();
    private final SQS sqs = SQSBuilder.standard().build();
    
    @Override
    public OrderResult handleRequest(OrderEvent event, Context context) {
        LambdaLogger logger = context.getLogger();
        logger.log("ì£¼ë¬¸ ì²˜ë¦¬ ì‹œì‘: " + event.getOrderId());
        
        try {
            // 1. ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
            Order order = getOrderFromDynamoDB(event.getOrderId());
            
            // 2. ì¬ê³  í™•ì¸
            if (!checkInventory(order)) {
                return OrderResult.failure("ì¬ê³  ë¶€ì¡±");
            }
            
            // 3. ê²°ì œ ì²˜ë¦¬
            PaymentResult paymentResult = processPayment(order);
            if (!paymentResult.isSuccess()) {
                return OrderResult.failure("ê²°ì œ ì‹¤íŒ¨");
            }
            
            // 4. ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateOrderStatus(order.getId(), "CONFIRMED");
            
            // 5. ë°°ì†¡ íì— ë©”ì‹œì§€ ì „ì†¡
            sendToShippingQueue(order);
            
            logger.log("ì£¼ë¬¸ ì²˜ë¦¬ ì™„ë£Œ: " + event.getOrderId());
            return OrderResult.success();
            
        } catch (Exception e) {
            logger.log("ì£¼ë¬¸ ì²˜ë¦¬ ì‹¤íŒ¨: " + e.getMessage());
            return OrderResult.failure(e.getMessage());
        }
    }
    
    private Order getOrderFromDynamoDB(String orderId) {
        // DynamoDBì—ì„œ ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
        Map<String, AttributeValue> key = new HashMap<>();
        key.put("orderId", new AttributeValue(orderId));
        
        GetItemRequest request = GetItemRequest.builder()
            .tableName("Orders")
            .key(key)
            .build();
            
        GetItemResponse response = dynamoDB.getItem(request);
        return mapToOrder(response.item());
    }
    
    private void sendToShippingQueue(Order order) {
        // SQSì— ë°°ì†¡ ë©”ì‹œì§€ ì „ì†¡
        String messageBody = objectMapper.writeValueAsString(
            new ShippingMessage(order.getId(), order.getCustomerId(), order.getAddress())
        );
        
        SendMessageRequest request = SendMessageRequest.builder()
            .queueUrl("https://sqs.region.amazonaws.com/account/shipping-queue")
            .messageBody(messageBody)
            .build();
            
        sqs.sendMessage(request);
    }
}
```

#### ì´ë²¤íŠ¸ ê¸°ë°˜ ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜

```yaml
# serverless.yml (Serverless Framework)
service: order-processing

provider:
  name: aws
  runtime: java11
  stage: ${opt:stage, 'dev'}
  region: ap-northeast-2

functions:
  processOrder:
    handler: com.example.OrderProcessor
    events:
      - sqs:
          arn: arn:aws:sqs:ap-northeast-2:123456789:order-queue
          batchSize: 10
    environment:
      ORDERS_TABLE: ${self:service}-orders-${self:provider.stage}
      SHIPPING_QUEUE_URL: ${cf:shipping-service-${self:provider.stage}.ShippingQueueUrl}

  processPayment:
    handler: com.example.PaymentProcessor
    events:
      - http:
          path: /payments
          method: post
          cors: true

resources:
  Resources:
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-orders-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: orderId
            AttributeType: S
        KeySchema:
          - AttributeName: orderId
            KeyType: HASH
```

### 4.2.4 ì„œë²„ë¦¬ìŠ¤ íŒ¨í„´

#### Event-Driven íŒ¨í„´
```java
// ì´ë²¤íŠ¸ ê¸°ë°˜ ì£¼ë¬¸ ì²˜ë¦¬ í”Œë¡œìš°
@Component
public class OrderEventHandler {
    
    // ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ ì²˜ë¦¬
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        // ì¬ê³  í™•ì¸ í•¨ìˆ˜ í˜¸ì¶œ
        inventoryService.reserveItems(event.getOrderId(), event.getItems());
    }
    
    // ì¬ê³  ì˜ˆì•½ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
    @EventListener
    public void handleInventoryReserved(InventoryReservedEvent event) {
        // ê²°ì œ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
        paymentService.processPayment(event.getOrderId(), event.getAmount());
    }
    
    // ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
    @EventListener
    public void handlePaymentCompleted(PaymentCompletedEvent event) {
        // ë°°ì†¡ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
        shippingService.createShipment(event.getOrderId());
    }
}
```

---

## 4.3 í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ (í¬íŠ¸ì™€ ì–´ëŒ‘í„°)

### 4.3.1 í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ë€?

í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì™¸ë¶€ ì„¸ê³„ë¡œë¶€í„° ê²©ë¦¬í•˜ì—¬ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ìš´ êµ¬ì¡°ë¥¼ ë§Œë“œëŠ” ì•„í‚¤í…ì²˜ íŒ¨í„´ì…ë‹ˆë‹¤.

#### í•µì‹¬ ê°œë…
- **í¬íŠ¸(Port)**: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì™¸ë¶€ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤
- **ì–´ëŒ‘í„°(Adapter)**: í¬íŠ¸ë¥¼ êµ¬í˜„í•˜ì—¬ ì‹¤ì œ ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì—°ê²°
- **ë„ë©”ì¸ ì¤‘ì‹¬**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì¤‘ì‹¬ì— ìœ„ì¹˜
- **ì˜ì¡´ì„± ì—­ì „**: ì™¸ë¶€ ì˜ì¡´ì„±ì´ ë‚´ë¶€ë¡œ í–¥í•˜ì§€ ì•ŠìŒ

### 4.3.2 ê³„ì¸µ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Adapters                  â”‚  â† ì™¸ë¶€ ì¸í„°í˜ì´ìŠ¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Ports                     â”‚  â† ì¸í„°í˜ì´ìŠ¤ ì •ì˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Application Services         â”‚  â† ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Domain Model                â”‚  â† í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3.3 í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ êµ¬í˜„ ì˜ˆì œ

#### ë„ë©”ì¸ ëª¨ë¸
```java
// Order.java (ë„ë©”ì¸ ì—”í‹°í‹°)
public class Order {
    private final OrderId id;
    private final CustomerId customerId;
    private final List<OrderItem> items;
    private OrderStatus status;
    private final LocalDateTime createdAt;
    
    public Order(CustomerId customerId, List<OrderItem> items) {
        this.id = OrderId.generate();
        this.customerId = customerId;
        this.items = new ArrayList<>(items);
        this.status = OrderStatus.PENDING;
        this.createdAt = LocalDateTime.now();
        
        validateOrder();
    }
    
    private void validateOrder() {
        if (items.isEmpty()) {
            throw new IllegalArgumentException("ì£¼ë¬¸ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤");
        }
        
        if (getTotalAmount().compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("ì£¼ë¬¸ ê¸ˆì•¡ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
        }
    }
    
    public void confirm() {
        if (status != OrderStatus.PENDING) {
            throw new IllegalStateException("ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤");
        }
        this.status = OrderStatus.CONFIRMED;
    }
    
    public BigDecimal getTotalAmount() {
        return items.stream()
                   .map(OrderItem::getAmount)
                   .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
    
    // getters...
}

// OrderItem.java (ê°’ ê°ì²´)
public class OrderItem {
    private final ProductId productId;
    private final int quantity;
    private final BigDecimal unitPrice;
    
    public OrderItem(ProductId productId, int quantity, BigDecimal unitPrice) {
        if (quantity <= 0) {
            throw new IllegalArgumentException("ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤");
        }
        if (unitPrice.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("ê°€ê²©ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤");
        }
        
        this.productId = productId;
        this.quantity = quantity;
        this.unitPrice = unitPrice;
    }
    
    public BigDecimal getAmount() {
        return unitPrice.multiply(BigDecimal.valueOf(quantity));
    }
    
    // getters...
}
```

#### í¬íŠ¸ ì •ì˜
```java
// OrderRepository.java (ì¶œë ¥ í¬íŠ¸)
public interface OrderRepository {
    void save(Order order);
    Optional<Order> findById(OrderId id);
    List<Order> findByCustomerId(CustomerId customerId);
}

// PaymentService.java (ì¶œë ¥ í¬íŠ¸)
public interface PaymentService {
    PaymentResult processPayment(OrderId orderId, BigDecimal amount);
}

// OrderService.java (ì…ë ¥ í¬íŠ¸)
public interface OrderService {
    OrderId createOrder(CreateOrderCommand command);
    void confirmOrder(OrderId orderId);
    Order getOrder(OrderId orderId);
}
```

#### ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤
```java
// OrderServiceImpl.java (ì…ë ¥ í¬íŠ¸ êµ¬í˜„)
@Service
@Transactional
public class OrderServiceImpl implements OrderService {
    
    private final OrderRepository orderRepository;
    private final PaymentService paymentService;
    private final InventoryService inventoryService;
    private final EventPublisher eventPublisher;
    
    public OrderServiceImpl(OrderRepository orderRepository,
                           PaymentService paymentService,
                           InventoryService inventoryService,
                           EventPublisher eventPublisher) {
        this.orderRepository = orderRepository;
        this.paymentService = paymentService;
        this.inventoryService = inventoryService;
        this.eventPublisher = eventPublisher;
    }
    
    @Override
    public OrderId createOrder(CreateOrderCommand command) {
        // 1. ì¬ê³  í™•ì¸
        for (OrderItemCommand item : command.getItems()) {
            if (!inventoryService.isAvailable(item.getProductId(), item.getQuantity())) {
                throw new InsufficientInventoryException("ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤: " + item.getProductId());
            }
        }
        
        // 2. ì£¼ë¬¸ ìƒì„±
        List<OrderItem> orderItems = command.getItems().stream()
                .map(item -> new OrderItem(item.getProductId(), item.getQuantity(), item.getUnitPrice()))
                .collect(Collectors.toList());
                
        Order order = new Order(command.getCustomerId(), orderItems);
        
        // 3. ì£¼ë¬¸ ì €ì¥
        orderRepository.save(order);
        
        // 4. ì´ë²¤íŠ¸ ë°œí–‰
        eventPublisher.publish(new OrderCreatedEvent(order.getId(), order.getCustomerId()));
        
        return order.getId();
    }
    
    @Override
    public void confirmOrder(OrderId orderId) {
        Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + orderId));
        
        // ê²°ì œ ì²˜ë¦¬
        PaymentResult paymentResult = paymentService.processPayment(orderId, order.getTotalAmount());
        
        if (paymentResult.isSuccess()) {
            order.confirm();
            orderRepository.save(order);
            
            eventPublisher.publish(new OrderConfirmedEvent(orderId));
        } else {
            throw new PaymentFailedException("ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨: " + paymentResult.getErrorMessage());
        }
    }
    
    @Override
    public Order getOrder(OrderId orderId) {
        return orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + orderId));
    }
}
```

#### ì–´ëŒ‘í„° êµ¬í˜„
```java
// JpaOrderRepository.java (ì¶œë ¥ ì–´ëŒ‘í„°)
@Repository
public class JpaOrderRepository implements OrderRepository {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @Override
    public void save(Order order) {
        OrderEntity entity = OrderMapper.toEntity(order);
        entityManager.merge(entity);
    }
    
    @Override
    public Optional<Order> findById(OrderId id) {
        OrderEntity entity = entityManager.find(OrderEntity.class, id.getValue());
        return Optional.ofNullable(entity)
                      .map(OrderMapper::toDomain);
    }
    
    @Override
    public List<Order> findByCustomerId(CustomerId customerId) {
        TypedQuery<OrderEntity> query = entityManager.createQuery(
            "SELECT o FROM OrderEntity o WHERE o.customerId = :customerId", 
            OrderEntity.class
        );
        query.setParameter("customerId", customerId.getValue());
        
        return query.getResultList().stream()
                   .map(OrderMapper::toDomain)
                   .collect(Collectors.toList());
    }
}

// RestOrderController.java (ì…ë ¥ ì–´ëŒ‘í„°)
@RestController
@RequestMapping("/api/orders")
public class RestOrderController {
    
    private final OrderService orderService;
    
    public RestOrderController(OrderService orderService) {
        this.orderService = orderService;
    }
    
    @PostMapping
    public ResponseEntity<CreateOrderResponse> createOrder(@RequestBody CreateOrderRequest request) {
        try {
            CreateOrderCommand command = new CreateOrderCommand(
                CustomerId.of(request.getCustomerId()),
                request.getItems().stream()
                    .map(item -> new OrderItemCommand(
                        ProductId.of(item.getProductId()),
                        item.getQuantity(),
                        item.getUnitPrice()
                    ))
                    .collect(Collectors.toList())
            );
            
            OrderId orderId = orderService.createOrder(command);
            
            return ResponseEntity.ok(new CreateOrderResponse(orderId.getValue()));
        } catch (Exception e) {
            return ResponseEntity.badRequest()
                    .body(new CreateOrderResponse(null, e.getMessage()));
        }
    }
    
    @PostMapping("/{orderId}/confirm")
    public ResponseEntity<Void> confirmOrder(@PathVariable String orderId) {
        try {
            orderService.confirmOrder(OrderId.of(orderId));
            return ResponseEntity.ok().build();
        } catch (OrderNotFoundException e) {
            return ResponseEntity.notFound().build();
        } catch (Exception e) {
            return ResponseEntity.badRequest().build();
        }
    }
}
```

---

## 4.4 CQRSì™€ ì´ë²¤íŠ¸ ì†Œì‹±

### 4.4.1 CQRS (Command Query Responsibility Segregation)

CQRSëŠ” ëª…ë ¹(Command)ê³¼ ì¡°íšŒ(Query)ì˜ ì±…ì„ì„ ë¶„ë¦¬í•˜ëŠ” íŒ¨í„´ìœ¼ë¡œ, ì½ê¸°ì™€ ì“°ê¸° ëª¨ë¸ì„ ê°ê° ìµœì í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### í•µì‹¬ ê°œë…
- **ëª…ë ¹ ëª¨ë¸**: ë°ì´í„° ë³€ê²½ ì‘ì—… ë‹´ë‹¹
- **ì¡°íšŒ ëª¨ë¸**: ë°ì´í„° ì½ê¸° ì‘ì—… ë‹´ë‹¹
- **ëª¨ë¸ ë¶„ë¦¬**: ê°ê° ë‹¤ë¥¸ ë°ì´í„° êµ¬ì¡°ì™€ ìµœì í™”
- **eventual Consistency**: ì½ê¸° ëª¨ë¸ì˜ ë¹„ë™ê¸° ì—…ë°ì´íŠ¸

### 4.4.2 ì´ë²¤íŠ¸ ì†Œì‹± (Event Sourcing)

ì´ë²¤íŠ¸ ì†Œì‹±ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒíƒœ ë³€ê²½ì„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì €ì¥í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.

#### í•µì‹¬ ê°œë…
- **ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼**: ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ìˆœì°¨ì  ì´ë²¤íŠ¸ë¡œ ì €ì¥
- **ì´ë²¤íŠ¸ ì¬ìƒ**: ì´ë²¤íŠ¸ë¥¼ ìˆœì„œëŒ€ë¡œ ì¬ìƒí•˜ì—¬ í˜„ì¬ ìƒíƒœ ë³µì›
- **ì‹œê°„ ì—¬í–‰**: ê³¼ê±° ì„ì˜ ì‹œì ì˜ ìƒíƒœ ì¡°íšŒ ê°€ëŠ¥
- **ê°ì‚¬ ì¶”ì **: ì™„ì „í•œ ë³€ê²½ ì´ë ¥ ë³´ì¡´

### 4.4.3 CQRS + ì´ë²¤íŠ¸ ì†Œì‹± êµ¬í˜„ ì˜ˆì œ

#### ì´ë²¤íŠ¸ ì •ì˜
```java
// OrderEvent.java (ê¸°ë³¸ ì´ë²¤íŠ¸)
public abstract class OrderEvent {
    private final String orderId;
    private final LocalDateTime occurredAt;
    private final String eventId;
    
    protected OrderEvent(String orderId) {
        this.orderId = orderId;
        this.occurredAt = LocalDateTime.now();
        this.eventId = UUID.randomUUID().toString();
    }
    
    // getters...
}

// OrderCreatedEvent.java
public class OrderCreatedEvent extends OrderEvent {
    private final String customerId;
    private final List<OrderItem> items;
    private final BigDecimal totalAmount;
    
    public OrderCreatedEvent(String orderId, String customerId, 
                           List<OrderItem> items, BigDecimal totalAmount) {
        super(orderId);
        this.customerId = customerId;
        this.items = items;
        this.totalAmount = totalAmount;
    }
    
    // getters...
}

// OrderConfirmedEvent.java
public class OrderConfirmedEvent extends OrderEvent {
    private final String paymentId;
    private final LocalDateTime confirmedAt;
    
    public OrderConfirmedEvent(String orderId, String paymentId) {
        super(orderId);
        this.paymentId = paymentId;
        this.confirmedAt = LocalDateTime.now();
    }
    
    // getters...
}
```

#### ëª…ë ¹ ì²˜ë¦¬ (Command Side)
```java
// OrderAggregate.java
public class OrderAggregate {
    private String id;
    private String customerId;
    private List<OrderItem> items;
    private OrderStatus status;
    private BigDecimal totalAmount;
    private List<OrderEvent> uncommittedEvents = new ArrayList<>();
    
    // ìƒì„±ì - ì´ë²¤íŠ¸ ì¬ìƒì„ í†µí•œ ìƒíƒœ ë³µì›
    public OrderAggregate(List<OrderEvent> events) {
        for (OrderEvent event : events) {
            apply(event);
        }
    }
    
    // ìƒˆ ì£¼ë¬¸ ìƒì„±
    public static OrderAggregate createOrder(String customerId, List<OrderItem> items) {
        OrderAggregate aggregate = new OrderAggregate(Collections.emptyList());
        
        String orderId = UUID.randomUUID().toString();
        BigDecimal totalAmount = items.stream()
                .map(OrderItem::getAmount)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        OrderCreatedEvent event = new OrderCreatedEvent(orderId, customerId, items, totalAmount);
        aggregate.applyAndRecord(event);
        
        return aggregate;
    }
    
    // ì£¼ë¬¸ í™•ì¸
    public void confirmOrder(String paymentId) {
        if (status != OrderStatus.PENDING) {
            throw new IllegalStateException("ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤");
        }
        
        OrderConfirmedEvent event = new OrderConfirmedEvent(id, paymentId);
        applyAndRecord(event);
    }
    
    // ì´ë²¤íŠ¸ ì ìš© ë° ê¸°ë¡
    private void applyAndRecord(OrderEvent event) {
        apply(event);
        uncommittedEvents.add(event);
    }
    
    // ì´ë²¤íŠ¸ ì ìš© (ìƒíƒœ ë³€ê²½)
    private void apply(OrderEvent event) {
        if (event instanceof OrderCreatedEvent) {
            apply((OrderCreatedEvent) event);
        } else if (event instanceof OrderConfirmedEvent) {
            apply((OrderConfirmedEvent) event);
        }
        // ë‹¤ë¥¸ ì´ë²¤íŠ¸ íƒ€ì…ë“¤...
    }
    
    private void apply(OrderCreatedEvent event) {
        this.id = event.getOrderId();
        this.customerId = event.getCustomerId();
        this.items = new ArrayList<>(event.getItems());
        this.status = OrderStatus.PENDING;
        this.totalAmount = event.getTotalAmount();
    }
    
    private void apply(OrderConfirmedEvent event) {
        this.status = OrderStatus.CONFIRMED;
    }
    
    public List<OrderEvent> getUncommittedEvents() {
        return new ArrayList<>(uncommittedEvents);
    }
    
    public void markEventsAsCommitted() {
        uncommittedEvents.clear();
    }
    
    // getters...
}

// OrderCommandHandler.java
@Service
public class OrderCommandHandler {
    
    private final EventStore eventStore;
    private final EventBus eventBus;
    
    public OrderCommandHandler(EventStore eventStore, EventBus eventBus) {
        this.eventStore = eventStore;
        this.eventBus = eventBus;
    }
    
    @CommandHandler
    public void handle(CreateOrderCommand command) {
        // ìƒˆ ì£¼ë¬¸ ìƒì„±
        OrderAggregate aggregate = OrderAggregate.createOrder(
            command.getCustomerId(),
            command.getItems()
        );
        
        // ì´ë²¤íŠ¸ ì €ì¥
        eventStore.saveEvents(aggregate.getId(), aggregate.getUncommittedEvents());
        
        // ì´ë²¤íŠ¸ ë°œí–‰
        for (OrderEvent event : aggregate.getUncommittedEvents()) {
            eventBus.publish(event);
        }
        
        aggregate.markEventsAsCommitted();
    }
    
    @CommandHandler
    public void handle(ConfirmOrderCommand command) {
        // ê¸°ì¡´ ì£¼ë¬¸ ë¡œë“œ
        List<OrderEvent> events = eventStore.getEvents(command.getOrderId());
        OrderAggregate aggregate = new OrderAggregate(events);
        
        // ì£¼ë¬¸ í™•ì¸
        aggregate.confirmOrder(command.getPaymentId());
        
        // ì´ë²¤íŠ¸ ì €ì¥ ë° ë°œí–‰
        eventStore.saveEvents(aggregate.getId(), aggregate.getUncommittedEvents());
        
        for (OrderEvent event : aggregate.getUncommittedEvents()) {
            eventBus.publish(event);
        }
        
        aggregate.markEventsAsCommitted();
    }
}
```

#### ì¡°íšŒ ì²˜ë¦¬ (Query Side)
```java
// OrderReadModel.java
@Entity
@Table(name = "order_read_model")
public class OrderReadModel {
    @Id
    private String id;
    private String customerId;
    private String customerName;
    private BigDecimal totalAmount;
    private String status;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // constructors, getters, setters...
}

// OrderProjection.java
@Component
public class OrderProjection {
    
    private final OrderReadModelRepository repository;
    
    public OrderProjection(OrderReadModelRepository repository) {
        this.repository = repository;
    }
    
    @EventHandler
    public void on(OrderCreatedEvent event) {
        OrderReadModel readModel = new OrderReadModel();
        readModel.setId(event.getOrderId());
        readModel.setCustomerId(event.getCustomerId());
        readModel.setTotalAmount(event.getTotalAmount());
        readModel.setStatus("PENDING");
        readModel.setCreatedAt(event.getOccurredAt());
        readModel.setUpdatedAt(event.getOccurredAt());
        
        repository.save(readModel);
    }
    
    @EventHandler
    public void on(OrderConfirmedEvent event) {
        repository.findById(event.getOrderId())
                  .ifPresent(readModel -> {
                      readModel.setStatus("CONFIRMED");
                      readModel.setUpdatedAt(event.getOccurredAt());
                      repository.save(readModel);
                  });
    }
}

// OrderQueryService.java
@Service
public class OrderQueryService {
    
    private final OrderReadModelRepository repository;
    
    public OrderQueryService(OrderReadModelRepository repository) {
        this.repository = repository;
    }
    
    public OrderReadModel getOrder(String orderId) {
        return repository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + orderId));
    }
    
    public List<OrderReadModel> getOrdersByCustomer(String customerId) {
        return repository.findByCustomerId(customerId);
    }
    
    public Page<OrderReadModel> getOrdersByStatus(String status, Pageable pageable) {
        return repository.findByStatus(status, pageable);
    }
}
```

---

## ğŸ¯ í•µì‹¬ ìš”ì•½

### ëª¨ë˜ ì•„í‚¤í…ì²˜ íŒ¨ëŸ¬ë‹¤ì„ ë¹„êµ

| **íŒ¨ëŸ¬ë‹¤ì„** | **ì£¼ìš” íŠ¹ì§•** | **ì ìš© ì‹œë‚˜ë¦¬ì˜¤** | **ì¥ì ** | **ê³ ë ¤ì‚¬í•­** |
|-------------|-------------|-----------------|---------|------------|
| **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤** | ì„œë¹„ìŠ¤ ë¶„í•´, ë…ë¦½ ë°°í¬ | ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ, ë‹¤ìˆ˜ íŒ€ | í™•ì¥ì„±, ê¸°ìˆ  ë‹¤ì–‘ì„± | ë³µì¡ì„±, ë°ì´í„° ì¼ê´€ì„± |
| **ì„œë²„ë¦¬ìŠ¤** | í•¨ìˆ˜ ê¸°ë°˜, ì´ë²¤íŠ¸ ë“œë¦¬ë¸ | ì´ë²¤íŠ¸ ì²˜ë¦¬, ê°„í—ì  ì‘ì—… | ìë™ ìŠ¤ì¼€ì¼ë§, ë¹„ìš© íš¨ìœ¨ | ë²¤ë” ì¢…ì†, ì½œë“œ ìŠ¤íƒ€íŠ¸ |
| **í—¥ì‚¬ê³ ë‚ ** | í¬íŠ¸-ì–´ëŒ‘í„°, ë„ë©”ì¸ ì¤‘ì‹¬ | ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ | í…ŒìŠ¤íŠ¸ ìš©ì´ì„±, ìœ ì—°ì„± | ì´ˆê¸° ë³µì¡ì„±, í•™ìŠµ ê³¡ì„  |
| **CQRS/ES** | ëª…ë ¹-ì¡°íšŒ ë¶„ë¦¬, ì´ë²¤íŠ¸ ì €ì¥ | ë³µì¡í•œ ë„ë©”ì¸, ê°ì‚¬ í•„ìš” | í™•ì¥ì„±, ê°ì‚¬ ì¶”ì  | ë³µì¡ì„±, ì¼ê´€ì„± ê´€ë¦¬ |

### íŒ¨ëŸ¬ë‹¤ì„ë³„ ì„ íƒ ê°€ì´ë“œ

1. **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤**: ì¡°ì§ì´ í¬ê³ , ë…ë¦½ì ì¸ íŒ€ êµ¬ì¡°, ë‹¤ì–‘í•œ ê¸°ìˆ  ìŠ¤íƒ í•„ìš”
2. **ì„œë²„ë¦¬ìŠ¤**: ì´ë²¤íŠ¸ ê¸°ë°˜ ì²˜ë¦¬, ê°„í—ì  ì›Œí¬ë¡œë“œ, ë¹ ë¥¸ í”„ë¡œí† íƒ€ì´í•‘
3. **í—¥ì‚¬ê³ ë‚ **: ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™, ë†’ì€ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í•„ìš”
4. **CQRS/ES**: ë³µì¡í•œ ë„ë©”ì¸, ì™„ì „í•œ ê°ì‚¬ ì¶”ì , ë†’ì€ ì½ê¸° ì„±ëŠ¥ í•„ìš”

---

## ğŸ’­ ìƒê°í•´ë³´ê¸°

1. í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ì— ê°€ì¥ ì í•©í•œ ì•„í‚¤í…§ì²˜ íŒ¨ëŸ¬ë‹¤ì„ì€ ë¬´ì—‡ì´ë©°, ê·¸ ì´ìœ ëŠ”?
2. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ ë„ì…í•  ë•Œ ê°€ì¥ í° ë„ì „ê³¼ì œëŠ” ë¬´ì—‡ì´ê³ , ì–´ë–»ê²Œ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ?
3. ì´ë²¤íŠ¸ ì†Œì‹±ì„ ì ìš©í•˜ê¸° ì í•©í•œ ë„ë©”ì¸ì˜ íŠ¹ì§•ì€ ë¬´ì—‡ì¸ê°€?

---

## ğŸ“š ì¶”ê°€ í•™ìŠµ ìë£Œ

### ë„ì„œ
- "Building Microservices" - Sam Newman
- "Serverless Architectures on AWS" - Peter Sbarski  
- "Clean Architecture" - Robert C. Martin
- "Implementing Domain-Driven Design" - Vaughn Vernon

### ì˜¨ë¼ì¸ ìë£Œ
- Netflix Technology Blog
- AWS Architecture Center
- Microsoft Azure Architecture Center
- Martin Fowler's Architecture Articles 